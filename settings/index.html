<!DOCTYPE html>
<html>

  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <script type="text/javascript">
      let module = {}; // Just to get around that some of the included files are used both by node.js and in the browser
      function onWizLoaded() {};
    </script>
    <script type="text/javascript" src="./constants.js"></script>
    <script type="text/javascript" src="./locale.js"></script>
    <script type="text/javascript" src="./devices.js"></script>
    <script type="text/javascript" src="./chart.js"></script>
    <script type="text/javascript" src="./tools.js"></script>
    <script type="text/javascript" src="./gridcost.js"></script>
    <script type="text/javascript" src="./homeytime.js"></script>
    <script type="text/javascript" src="subpages/wizzard.js"></script>
    <script type="text/javascript" src="subpages/logPage.js"></script>
    <script type="text/javascript" src="subpages/graphs.js"></script>
    <script type="text/javascript" src="subpages/advanced.js"></script>
    <link href="style.css" rel="stylesheet" type="text/css">
    <link href="trashcan.css" rel="stylesheet" type="text/css">
    <script type="text/javascript">

      function resizeIframe(tabPage, width, height) {
        let holder = document.getElementById(tabPage);
        let inner =  document.getElementById(`${tabPage}Inner`);
        try {
          holder.style.height = height + 'px';
          holder.style.width = width + 'px';
          console.log(`Resized to: ${holder.style.width}, ${holder.style.height}`);
        } catch (err) {
          console.log(`Rezise Error: ${err}`);
        }
      }

      // Text strings that must be fetched from homey
      var unitsText = "units";
      var timeScheduleText = "settings.schedule";
      var ACModeText = "settings.ACMode";
      var thermostatText = "thermostat";
      var activeText = "settings.mode.active";
      var noPowText = "settings.mode.noMeterPower";
      var deltaText = "settings.price.delta";
      var actionText = "settings.price.action";
      var deviceText = "settings.mode.device";
      var turnOnText = "settings.schedule.operations.controlledOn";
      var turnOffText = "settings.schedule.operations.alwaysOff";
      var minTempText = "settings.frost.minTemp";
      var priorityText = "settings.mode.priority";
      var alwaysOnText = "settings.mode.alwaysOn";
      var priceDirtCheapText = "settings.price.actionDirtCheap";
      var priceLowText = "settings.price.actionLow";
      var alwaysOffText = "settings.mode.alwaysOff";
      var priceHighText = "settings.price.actionHigh";
      var priceExtremeText = "settings.price.actionExtreme";
      var deltaTempText = "settings.price.deltaTemp";
      var emergencyOffText = "settings.schedule.operations.controlledOff";
      var ignoreText = "settings.schedule.operations.ignore";
      var targetTempText = "settings.mode.targetTemp";
      var controlledText = "settings.mode.controlled";
      var priceNormalText = "settings.price.actionNormal";
      var leavePageText = "settings.alert.leavepage";
      var zoneNameText = "settings.zone.zoneName";
      var zoneNumText = "settings.zone.zoneNum";
      var overrideDeviceText = "settings.override.device";
      var overrideStatusText = "settings.override.status";
      var overrideonText = "settings.override.on";
      var overrideoffText = "settings.override.off";
      var overrideoffUntilOnText = "settings.override.offUntilOn";
      var overridetempText = "settings.override.temp";
      var overridefrostText = "settings.override.frost";
      var overrideControlledText = "settings.override.controlled";
      var overrideZoneText = "settings.override.zone";
      var helpButtons = "settings.price.buttons.help";
      var helpButtonOn = "settings.price.buttons.helpOn";
      var helpButtonOff = "settings.price.buttons.helpOff";
      var helpButtonDelta = "settings.price.buttons.helpDelta";
      var helpButtonEmergency = "settings.price.buttons.helpEmergency";
      var helpButtonIgnore = "settings.price.buttons.helpIgnore";
      var timeoutText = "warnings.timeout";
      var energyFlowRateText = "settings.welcome.taskEnergyFlowRate";
      var experimentalText = "settings.welcome.taskExperimental";
      var spookeyText = "settings.welcome.taskSpookey";
      var onGoingText = "settings.help.ongoing";
      var modeNameDayText = "settings.opMode.normal";
      var modeNameNightText = "settings.opMode.night";
      var modeNameHolidayText = "settings.opMode.holiday";
      var modeNameCustomText = "settings.opMode.custom";
      var stepText = 'settings.mode.powerStep';
      var reliabilityText = 'settings.welcome.reliability';
      var reliabilityHelp = 'settings.welcome.reliabilityHelp';
      var deviceTypeText = [
        "settings.help.deviceTypeSwitch",
        "settings.help.deviceTypeHeater",
        "settings.help.deviceTypeWaterHeater",
        "settings.help.deviceTypeAC",
        "settings.help.deviceTypeCharger",
        "settings.help.deviceTypeIgnore",
        "settings.help.deviceTypeMeter"
      ];
      var chargePlanGraphTitle = "chargePlanGraph.title";
      var chargePlanGraphYAxis = "chargePlanGraph.yaxis";
      var chargePlanGraphPrice = "chargePlanGraph.price";
      var chargePlanGraphCharge = "chargePlanGraph.charging";
      var chargePlanGraphNoCharge = "chargePlanGraph.nocharge";
      var chargePlanGraphNoPrice = "chargePlanGraph.noPrice";
      var withSubsidyText = "chargePlanGraph.withSubsidy";
      var withoutSubsidyText = "chargePlanGraph.withoutSubsidy";

      var debugMode = false;

      var needModeRefresh = true;
      var numErrorDevices = 0;
      var noPrices = true;

      var KEEP = -1;
      var ALWAYS_OFF = 0;
      var ALWAYS_ON = 1;
      var CONTROLLED = 2;

      const PP_LOW = 0;
      const PP_NORM = 1;
      const PP_HIGH = 2;
      const PP_EXTREME = 3;
      const PP_DIRTCHEAP = 4;

      const TURN_ON = 0;
      const TURN_OFF = 1;
      const DELTA_TEMP = 2;
      const EMERGENCY_OFF = 3;
      const IGNORE = 4;

      const MAXLEN_DEVICETEXT = 12

      var deviceList = {
        id_a: { name:"DeviceNamenamenamenamename 1", room: "Stue",    image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: true, priority: 0, thermostat_cap: true, driverId: 'no.thermofloor:TF_Thermostat' },
        id_b: { name:"DeviceName 2", room: "Kj√∏kken", image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: true, priority: 1, thermostat_cap: true, reliability: 0.5, driverId: 'no.thermofloor:Z-TRM2fx' },
        id_c: { name:"DeviceName 3", room: "Bad",     image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: true, priority: 0, thermostat_cap: false, reliability: 0.6, driverId: 'no.thermofloor:Z-TRM3' },
        id_d: { name:"DeviceName 4", room: "Bad",     image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: false, priority: 1, thermostat_cap: true, reliability: 0.7, driverId: 'se.husdata:H60' },
        id_e: { name:"DeviceName 3", room: "Bad",     image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: true, priority: 0, thermostat_cap: false, reliability: 0.6, driverId: 'com.everspring:AN179' },
        id_e: { name:"Lader", room: "Ute",     image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: false, priority: 1, thermostat_cap: false, reliability: 1.0, driverId: 'no.easee:charger' }
      }
      // The modeList is not indexed by id because it uses the index to sort the list
      var modeList = [ [], [], [] ];
      var modeNames = [];
      var frostList = {}; // Indexed by deviceId
      var zoneList = {}; // Indexed by zone-id
      var overrideList = {};
      var priceActionList = [ {}, {}, {}, {}, {} ]; // Indexed by deviceId
      var currentPricePoint = 1; // Normal
      var currentOperatingMode = 0; // Disabled
      var currentErrorMargin = 5;
      var currentfreeThreshold = 100;
      var currentSafetyPower = 500;
      var currentMainFuse = 63;
      var futurePriceOptions = {};
      var chargerOptions = {};
      var appConfigProgress = {ApiStatus:0};
      var currentModeTab = 0; // Normal
      var loadedMaxPower = undefined;

      var pricePoints = [
        { name:"settings.pricetab.dirtcheap", value: PP_DIRTCHEAP },
        { name:"settings.pricetab.cheap", value: PP_LOW },
        { name:"settings.pricetab.normal", value: PP_NORM },
        { name:"settings.pricetab.expensive", value: PP_HIGH },
        { name:"settings.pricetab.extreme", value: PP_EXTREME }
      ]

      function limitText(text) {
        const splitText = text.split(" ", 5);
        for (let i = 0; i < splitText.length; i++) {
          if (splitText[i].length > MAXLEN_DEVICETEXT) {
            let firstPart = splitText[i].substring(0,MAXLEN_DEVICETEXT);
            let secondPart = splitText[i].substring(MAXLEN_DEVICETEXT);
            splitText.splice(i, 1, firstPart);
            splitText.splice(i+1, 0, secondPart);
            // console.log(`${splitText}`);
            if (splitText.length > 5) {
              splitText.pop();
            }
          }
        }
        return splitText.join(" ")
      }

      function generateEnableList(listName, priority) {
        var list = document.getElementById(listName);
        var gen_list = "<table class=device-list>";
        let found_experimental_on = false;
        let experimentalId = 'experimental' + priority;
        for (var key in deviceList) {
          var device = deviceList[key];
          if ((device.priority != priority)
            || (device.driverId in DEVICE_CMD && DEVICE_CMD[device.driverId].type === DEVICE_TYPE.IGNORE)) {
            continue;
          }
          let experimental = !(device.driverId in DEVICE_CMD) || ("beta" in DEVICE_CMD[device.driverId]);
          let hasNote = (device.driverId in DEVICE_CMD) && ("note" in DEVICE_CMD[device.driverId]);
          found_experimental_on |= device.use && experimental;
          let enabledImg = device.use ? experimental ? "experimental.png" : "enabled.png" : "disabled.png";
          let experimentalCmd = experimental ? 'document.getElementById(\'' + experimentalId + '\').style.display=\'block\';' : '';
          let noteButton = hasNote ? ` <div class="hintButton" onclick="toggle(this,'note${key}', 'table-row');return false;" style="display:inline-block">i</div>` : '';
          let noteText = hasNote ? `<tr id="note${key}" class="hint"><td colspan=4><p>${DEVICE_CMD[device.driverId].note}</p></td></tr>` : '';
          let img_text = device.image ? `<img src="${device.image}" alt="icon">` : '';
          gen_list +=
            '<tr>' +
            `  <td>${img_text}</td>` +
            '  <td><input type="image" width="40" height="20" src="' + enabledImg + '" onclick="' + experimentalCmd + 'toggleEnableDevice(event, \'' + String(key) + '\');displaySaveHint()" id="enableDevice' + String(key) + '"></td>' +
            '  <td><h3>' + limitText(device.name) + `${noteButton}</h3></td>` +
            '  <td><p>' + device.room + '</p></td>' +
            `</tr>${noteText}`;
        }
        gen_list += "</table>";
        gen_list += '<div id="' + experimentalId + '" style="display:' + (found_experimental_on?'block':'none') + ';">' + experimentalText + '</div>';
        list.innerHTML = gen_list;
      }

      function generateReliabilityList() {
        var list = document.getElementById('errorDeviceList');
        var genList = '<table class=device-list>';
        numErrorDevices = 0;
        for (var key in deviceList) {
          let device = deviceList[key];
          if (device.use && device.reliability < 0.9) {
            numErrorDevices += 1;
            let helptext = reliabilityHelp;
            if (device.driverId in DEVICE_CMD && 'workaround' in DEVICE_CMD[device.driverId]) {
              helptext = DEVICE_CMD[device.driverId].workaround;
            }
            genList +=
              `<tr onclick="toggle(this,'reliability_${key}');">` +
                `<td valign="top"><b>${device.name} <span style="background-color: #f1f1f1;border: 1px solid black;">&#8628;</span></b></td>` +
                `<td valign="top">${reliabilityText} : ${Math.round(device.reliability*100)}%</td>` +
              '</tr>' +
              '<tr>' +
                `<td colspan=2><div id="reliability_${key}" style="display:none;" class="hint">${device.name} - ${device.room}<br>${helptext}</div></td>` +
              '</tr>';
          }
        }
        genList += '</table>';
        list.innerHTML = genList;
      }
      
      function toggleEnableDevice(event, device_id) {
        var button = document.getElementById('enableDevice' + String(device_id))
        deviceList[device_id].use ^= true;
        var experimental = !(deviceList[device_id].driverId in DEVICE_CMD) || ("beta" in DEVICE_CMD[deviceList[device_id].driverId]);
        button.src = deviceList[device_id].use ? experimental ? "experimental.png" : "enabled.png" : "disabled.png";
      }

      function updateOperatingModes(selectedMode) {
        var list = document.getElementById("operatingMode");
        var appEn = document.getElementById("appEnabled");
        var options = '';
        if (selectedMode === 0) {
          appEn.value = 0;
          list.value = 1;
        } else {
          appEn.value = 1;
          list.value = selectedMode;
        }
      }

      function updatePricePoints(selectedPoint) {
        var list = document.getElementById("pricePoint");
        var options = '';
        for (var i = 0; i < pricePoints.length; i++) {
          options += '<option value="' + pricePoints[i].value + '" ' 
            + ((selectedPoint==i) ? 'selected' : '') + '>' + pricePoints[i].name + '</option>';
        }
        list.innerHTML = options;
      }

      function updateCountries(selectedCountry, schema) {
        var list = document.getElementById('priceCountry');
        setSchema(selectedCountry, schema);
        var options = '';
        const countries = Object.keys(ENTSOE_BIDDING_ZONES);
        for (var i = 0; i < countries.length; i++) {
          options += '<option value="' + countries[i] + '" '
            + ((selectedCountry==countries[i]) ? 'selected' : '') + `>${COUNTRY[countries[i]]} (${countries[i].toUpperCase()})</option>`;
        }
        list.innerHTML = options;
      }

      function updateRegions(selectedCountry, selectedRegion) {
        var list = document.getElementById('priceRegion');
        var options = '';
        const regions = ENTSOE_BIDDING_ZONES[selectedCountry];
        for (var i = 0; i < regions.length; i++) {
          options += '<option value="' + i + '" '
            + ((selectedRegion==i) ? 'selected' : '') + '>' + regions[i].name + '</option>';
        }
        list.innerHTML = options;
      }

      function generateFrostList() {
        var list = document.getElementById("frostList");
        var gen_list =
          '<table class="device-list">' +
            '<tr>' +
              '<th>&nbsp;</th>' +
              '<th align="left" colspan="2">' + minTempText + '</th>' +
            '</tr>';
        for (var deviceId in frostList) {
          var device = deviceList[deviceId]; // refreshFrostList already called, so indexing by deviceId is safe
          var frost_temp_input = device.thermostat_cap ? '<input type="number" id="minTemp' + String(deviceId) + '" min=0 max=15 size="4" onchange="setFrostTemp(this, \'' + String(deviceId) + '\');displaySaveHint()" value="' + String(frostList[deviceId].minTemp) + '">¬∞C' : '-';
          gen_list +=
            '<tr>' +
              '<td><img src="' + device.image + '" alt="icon" width="auto" height="50"></td>' +
              '<td><h3>' + limitText(device.name) + '</h3>' +
                '<p>' + device.room + '</p></td>' +
              '<td>' + frost_temp_input + '</td>' +
            '</tr>';
        }
        gen_list += "</table>";
        list.innerHTML = gen_list;
      }

      function generateOverrideList() {
        var list = document.getElementById("overrideList");
        var gen_list =
          '<table width="100%" class="device-list">' +
            '<tr>' +
              '<th style="text-align:left" width="60%">' + overrideDeviceText + '</th>' +
              '<th style="text-align:left" width="40%">' + overrideStatusText + '</th>' +
            '</tr>';
        for (deviceId in deviceList) {
          if (deviceList[deviceId].use) {
            let reasons = []; // Reason for override
            switch (overrideList[deviceId]) {
              case OVERRIDE.ON:
                reasons.push(overrideonText);
                break;
              case OVERRIDE.OFF:
                reasons.push(overrideoffText);
                break;
              case OVERRIDE.OFF_UNTIL_MANUAL_ON:
                reasons.push(overrideoffUntilOnText);
                break;
              case OVERRIDE.MANUAL_TEMP:
                reasons.push(overridetempText);
                break;
              case OVERRIDE.FROST_GUARD:
                reasons.push(overridefrostText);
                break;
              case OVERRIDE.CONTROLLED:
                reasons.push(overrideControlledText);
              default: // No override
                // reasons.push("blah");
                break;
            }

            for (zone in zoneList) {
              if (zoneList[zone].enabled === false && deviceList[deviceId].memberOf.includes(zone)) {
                reasons.push(overrideZoneText.replace("${zone}", `"${limitText(zoneList[zone].name)}"`));
              }
            }
            if (reasons.length > 0) {
              gen_list +=
              "<tr>" +
                `<td><h3>${limitText(deviceList[deviceId].name)}</h3><p>${limitText(deviceList[deviceId].room)}</p></td>` +
                `<td><p>${reasons.join('</p><p>')}</p></td>` +
              "</tr>";
            }
          }
        }
        gen_list += '</table>';
        list.innerHTML = gen_list;
      }

      function generateZoneList() {
        var list = document.getElementById("zoneList");
        var gen_list =
          '<table width="100%" class="device-list">' +
            '<tr>' +
              '<th style="text-align:left" width="60%">' + zoneNameText + '</th>' +
              '<th style="text-align:left" width="40%">' + zoneNumText + '</th>' +
            '</tr>';
        for (zone in zoneList) {
          if (zoneList[zone].enabled === false) {
            var num_affected_devices = 0;
            for (deviceId in deviceList) {
              if (deviceList[deviceId].use && deviceList[deviceId].memberOf.includes(zone)) {
                num_affected_devices++;
              }
            }
            gen_list +=
              "<tr>" +
                "<td><h3>" + limitText(zoneList[zone].name) + "</h3></td>" +
                "<td>" + String(num_affected_devices) + "</td>" +
              "</tr>";
          } // else the zone has been enabled again
        }
        gen_list += '</table>';
        list.innerHTML = gen_list;
      }

      function clearZones() {
        zoneList = {};
        generateZoneList();
      }

      function generatePriceActionList(tabPage) {
        document.getElementById("priceActionList").style.opacity = "0";
        setTimeout(function () {
          // Generate page
          var legendText = "";
          var minClamp = -40;
          var maxClamp = 40;
          switch (tabPage) {
            case PP_LOW: minClamp = 0; legendText = priceLowText; break;
            case PP_NORM: legendText = priceNormalText; break;
            case PP_HIGH: maxClamp = 0; legendText = priceHighText; break;
            case PP_EXTREME: maxClamp = 0; legendText = priceExtremeText; break;
            case PP_DIRTCHEAP: minClamp = 0; legendText = priceDirtCheapText; break;
          }
          var displayTemp = document.getElementById("controlTemp").value >= 1;
          var priceTabText =
            '<fieldset>' +
              '<legend>' + legendText + ' <div class="hintButton" onclick="toggle(this,\'priceActionHint\');return false;">i</div></legend>' +
              '<p id="priceActionHint" class="hint">' + helpButtons + ':<br>' +
                '<span class="imgButtonText" id="demoButton1" onclick="return false;">N/A</span> ' + helpButtonOn + '<br>' +
                '<span class="imgButtonText" id="demoButton2" onclick="return false;">N/A</span> ' + helpButtonOff + '<br>' +
                '<span class="imgButtonText" id="demoButton3" onclick="return false;">N/A</span> ' + helpButtonDelta + '<br>' +
                '<span class="imgButtonText" id="demoButton4" onclick="return false;">N/A</span> ' + helpButtonEmergency + '<br>' +
                '<span class="imgButtonText" id="demoButton5" onclick="return false;">N/A</span> ' + helpButtonIgnore + '<br>' +
                '' +
                '' +
              '</p>' +
              '<table class="device-list">' +
                '<tr>' +
                '<th>&nbsp;</th>' +
                '<th align="left">' + deviceText + '</th>' +
                '<th align="left">' + actionText + '</th>' +
                (displayTemp ? `<th align="left">${deltaText}</th>` : '') +
              '</tr>';
          for (var deviceId in priceActionList[tabPage]) {
            var device = deviceList[deviceId]; // refreshPriceActionList already called so indexing by deviceId should be safe
            let stepValue = (device.driverId in DEVICE_CMD) ? DEVICE_CMD[device.driverId].tempStep : 1;
            var price_temp_input = device.thermostat_cap ? `<input type="number" id="deltaTemp${String(deviceId)}" min=${minClamp} max=${maxClamp} size="4" step="${stepValue}" onchange="setDeltaTemp(this, ${String(tabPage)}, '${String(deviceId)}');displaySaveHint()" value="${String(priceActionList[tabPage][deviceId].delta)}">¬∞C` : '-';
            priceTabText +=
              '<tr>' +
                '<td><img src="' + device.image + '" alt="icon" width="auto" height="50"></td>' +
                '<td><h3>' + limitText(device.name) + '</h3>' +
                  '<p>' + device.room + '</p></td>' +
                '<td><div class="imgButtonText" id="priceActionButton' + String(deviceId) + '" onclick="updatePriceAction(this, ' + String(tabPage) + ', \'' + String(deviceId) + '\');displaySaveHint()">N/A</div></td>' +
                (displayTemp ? `<td>${price_temp_input}</td>` : '') +
              '</tr>';
          }
          priceTabText +=
              '</table>' +
            '</fieldset>';
          document.getElementById("priceActionList").innerHTML = priceTabText;
          document.getElementById("priceActionList").style.opacity = "1";

          // Refresh states on list elements
          updatePriceAction(document.getElementById('demoButton1'), undefined, undefined, TURN_ON);
          updatePriceAction(document.getElementById('demoButton2'), undefined, undefined, TURN_OFF);
          updatePriceAction(document.getElementById('demoButton3'), undefined, undefined, DELTA_TEMP);
          updatePriceAction(document.getElementById('demoButton4'), undefined, undefined, EMERGENCY_OFF);
          updatePriceAction(document.getElementById('demoButton5'), undefined, undefined, IGNORE);
          for (var deviceId in priceActionList[tabPage]) {
            updatePriceAction(document.getElementById('priceActionButton' + String(deviceId)), tabPage, deviceId, KEEP);
          }
        }, 250);
      }

      function generatePriorityList(listNum) {
        var displayTemp = document.getElementById("controlTemp").value >= 1;
        var list = document.getElementById("priorityList");
        var gen_list =
          '<table class="device-list">' +
            '<tr>' +
              '<th colspan="3" align="left">' + priorityText + '</th>' +
              '<th align="left">' + deviceText + '</th>' +
              (displayTemp ? `<th align="left">${targetTempText}</th>` : '') +
            '</tr>';
        for (var i = 0; i < modeList[listNum].length; i++) {
          var device = deviceList[modeList[listNum][i].id]; // refreshModeLists already called so should be safe to index deviceList with modeList[listNum][i].id
          var upenabled  = (i==0) ? 'disabled' : '';
          var dwnenabled = (i==modeList[listNum].length-1) ? 'disabled' : '';
          var target_temp_input = device.thermostat_cap ? '<input type="number" id="targetTemp' + String(i) + '" min=0 max=90 step="0.5" size="4" onchange="setTargetTemp(this,' + String(listNum) + ',' + String(i) + ');displaySaveHint()" value="' + String(modeList[listNum][i].targetTemp) + '">¬∞C' : '-';
          gen_list +=
            '<tr>' +
              '<td><input ' + upenabled + ' type="image" width="40" height="15" src="up_arrow.png" onclick="moveDevice(event, ' + String(listNum) + ', ' + String(i) + ',-1);displaySaveHint()" id="moveDeviceUp' + String(i) + '"/><br>' +
                  '<input ' + dwnenabled + ' type="image" width="40" height="15" src="down_arrow.png" onclick="moveDevice(event, ' + String(listNum) + ', ' + String(i) + ',+1);displaySaveHint()" id="moveDeviceDown' + String(i) + '"/></td>' +
              '<td><img src="' + device.image + '" alt="icon" width="auto" height="50"></td>' +
              '<td><div class="imgButtonText" id="deviceStateButton' + String(i) + '" onclick="updateState(this, ' + String(listNum) + ', ' + String(i) + ');displaySaveHint()">N/A</div></td>' +
              '<td><h3>' + limitText(device.name) + '</h3>' +
                  '<p>' + device.room + '</p></td>' +
                  (displayTemp ? `<td>${target_temp_input}</td>` : '') +
            '</tr>';
        }
        gen_list += "</table>";
        list.innerHTML = gen_list;

        // Refresh states on list elements
        for (var i = 0; i < modeList[listNum].length; i++) {
          updateState(document.getElementById('deviceStateButton' + String(i)), listNum, i, KEEP);
        }
      }

      function updateCostSchemas() {
        const costSchemaElement = document.getElementById('costSchema');
        let newValues = '';
        const schemeKeys = Object.keys(SCHEMA);
        for (let i = 0; i < schemeKeys.length; i++) {
          const scheme = SCHEMA[schemeKeys[i]];
          newValues += `<option value='${schemeKeys[i]}'>${scheme.name}</option>`;
        }
        costSchemaElement.innerHTML = newValues;
      }

      function updatePriceAction(button, pricePoint, device_id, newstate = undefined) {
        var deltaTempInput = undefined;
        var displayTemp = document.getElementById("controlTemp").value >= 1;
        if (pricePoint !== undefined) {
          if (newstate == undefined) {
            newstate = (priceActionList[pricePoint][device_id].operation + 1) % 5;
          } else if (newstate == KEEP) {
            newstate = priceActionList[pricePoint][device_id].operation;
          }
          var device = deviceList[device_id]; // refreshPriceActionList already called so should be safe to index by elements from priceActionList[tabPage]
          if (!(device.thermostat_cap && displayTemp) && newstate == DELTA_TEMP) {
            newstate = EMERGENCY_OFF;
          }
          priceActionList[pricePoint][device_id].operation = newstate;
          deltaTempInput =  document.getElementById('deltaTemp' + String(device_id));
        }
        switch (newstate) {
          case TURN_OFF:
            button.innerHTML=turnOffText;
            button.style.backgroundImage = 'radial-gradient(white, lightgray, gray)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
          case TURN_ON:
            button.innerHTML=turnOnText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(255, 255, 150), orange)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
          case DELTA_TEMP:
            button.innerHTML=deltaTempText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(150, 255, 150), green)';
            if (deltaTempInput) deltaTempInput.disabled = false;
            break;
          case EMERGENCY_OFF:
            button.innerHTML=emergencyOffText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(150, 255, 150), green)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
          case IGNORE:
            button.innerHTML=ignoreText;
            button.style.backgroundImage = 'radial-gradient(white, lightgray, gray)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
        }
      }

      function updateState(button, listNum, device_id, newstate = undefined) {
        let oldstate = modeList[listNum][device_id].operation
        if (newstate === undefined) {
          newstate = (oldstate + 1) % 3;
        } else if (newstate == KEEP) {
          newstate = oldstate;
        }
        switch (newstate) {
          case ALWAYS_OFF:
            button.innerHTML=alwaysOffText;
            button.style.backgroundImage = 'radial-gradient(white, lightgray, gray)';
            break;
          case ALWAYS_ON:
            button.innerHTML=alwaysOnText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(255, 150, 150), red)';
            break;
          case CONTROLLED:
            button.innerHTML=controlledText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(150, 255, 150), green)';
            break;
        }
        modeList[listNum][device_id].operation = newstate;
      }

      function moveDevice(event, listNum, device_id, delta) {
        if ((device_id + delta < 0) || (device_id + delta >= modeList[listNum].length)) {
          return;
        }
        var temp1 = modeList[listNum][device_id];
        var temp2 = modeList[listNum][device_id + delta];
        modeList[listNum][device_id] = temp2;
        modeList[listNum][device_id + delta] = temp1;
        generatePriorityList(listNum);
      }

      function checkPriceMode(source) {
        var priceControl = document.getElementById('priceControl');
        var priceUpperPart = document.getElementById('priceUpperPart');
        var priceLowerPart = document.getElementById('priceLowerPart');
        if (+source.value == PRICE_MODE_INTERNAL) {
          // Automatic - Prices from Utilitycost
          priceControl.style.display = 'block';
          priceUpperPart.style.display = 'block';
          priceLowerPart.style.display = 'block';
        } else if (+source.value == PRICE_MODE_FLOW) {
          // Manual - External price point
          priceControl.style.display = 'none';
          priceUpperPart.style.display = 'block';
          priceLowerPart.style.display = 'block';
        } else { // Value = PRICE_MODE_DISABLED
          // Disabled
          priceControl.style.display = 'none';
          priceUpperPart.style.display = 'none';
          priceLowerPart.style.display = 'none';
        }
      }

      function checkPriceKind() {
        var source = document.getElementById("priceKind");
        var priceSpotPart =  document.getElementById('priceSpotPart');
        var priceFixedPart =  document.getElementById('priceFixedPart');
        var priceInterpretPart =  document.getElementById('priceInterpretPart');
        var priceFixedAndSpotPart = document.getElementById('priceFixedAndSpotPart');
        var apiErrorPart = document.getElementById("errp1");
        var pp2Part = document.getElementById('subtablink2');
        var pp3Part = document.getElementById('subtablink3');
        var pp4Part = document.getElementById('subtablink4');
        var regionPart = document.getElementById('regionPart');
        let subisidyOn = document.getElementById("govSubsidy").checked;

        if (+source.value == PRICE_KIND_SPOT) {
          // Spot price
          priceSpotPart.style.display = 'block';
          priceFixedPart.style.display = 'none';
          priceInterpretPart.style.display = 'block';
          priceFixedAndSpotPart.style.display = 'block';
          apiErrorPart.style.display = 'none';
          pp2Part.style.display = 'table-cell';
          pp3Part.style.display = 'table-cell';
          pp4Part.style.display = 'table-cell';
          regionPart.style.display = 'table-row';
        } else if (+source.value == PRICE_KIND_EXTERNAL) {
          // External app Utility bill
          priceSpotPart.style.display = 'none';
          priceFixedPart.style.display = 'none';
          priceInterpretPart.style.display = 'block';
          priceFixedAndSpotPart.style.display = 'none';
          apiErrorPart.style.display = (appConfigProgress.ApiStatus != 2) ? 'table-row' : 'none';
          pp2Part.style.display = 'table-cell';
          pp3Part.style.display = 'table-cell';
          pp4Part.style.display = 'table-cell';
          regionPart.style.display = 'none';
        } else { // Value = PRICE_KIND_FIXED
          // Fixed price
          priceSpotPart.style.display = 'none';
          priceFixedPart.style.display = 'block';
          priceInterpretPart.style.display = subisidyOn ? 'block' : 'none';
          priceFixedAndSpotPart.style.display = 'block';
          apiErrorPart.style.display = 'none';
          pp2Part.style.display = subisidyOn ? 'table-cell' : 'none';
          pp3Part.style.display = subisidyOn ? 'table-cell' : 'none';
          pp4Part.style.display = subisidyOn ? 'table-cell' : 'none';
          regionPart.style.display = subisidyOn ? 'table-row' : 'none';
        }
      }

      function displaySaveHint() {
        var rememberToSaveElement = document.getElementById("rememberToSave");
        rememberToSaveElement.style.display = 'block';
      }

      function updateMaxPowerList() {
        let selector = document.getElementById('maxPowerList');
        let maxPower = document.getElementById('maxPowerHour').value;
        let lines = '';
        for (let i = 0; i < gridCost.length; i++) {
          let { limit } = gridCost[i];
          let limitBelow = +getGridBelow(limit);
          if (Number.isNaN(limitBelow)) limitBelow = 0;
          if ((limit > 0) && (limit <= 100000)) {
            let selectedText = (limit == maxPower) ? ' selected' : '';
            lines += `<option value="${limit}"${selectedText}>${stepText} ${i+1} - ${limitBelow/1000}-${limit/1000} kWh</option>`;
          }
        }
        selector.innerHTML = lines;
      }

      function setMaxPowerHour(value, min, max) {
        // Update table
        updateMaxPowerList();
        // Select item
        if(value != "") {
          if(parseInt(value) < parseInt(min)) { value = min; }
          if(parseInt(value) > parseInt(max)) { value = max; }
          document.getElementById('maxPowerHour').value = value;
          document.getElementById('maxPowerList').value = value;
        }
      }

      function addMaxPowerElement() {
        let table = document.getElementById('gridCostsTable');
        let newId = table.rows.length;
        if (newId == 20) return;
        if (newId > gridCost.length) {
          gridCost.push({...gridCost[gridCost.length-1]});
        }
        let newRow = table.insertRow(-1);
        let newCell1 = newRow.insertCell(0);
        let newCell2 = newRow.insertCell(1);
        newCell1.className = "settings_row_input";
        newCell2.className = "settings_row_input";
        let { limit, price } = gridCost[newId-1];
        let min = (newId <= 1) ? 0 : gridCost[newId-2].limit;
        let max = (newId >= gridCost.length-1) ? 100000 : gridCost[newId].limit;
        newCell1.innerHTML = `<input class="inputElem" id="gridLimit${newId}" type="number" min="${min}" max="${max}" step="100" value="${limit}" onchange="updateMaxPowerElement(this,${newId});displaySaveHint()">Wh`;
        newCell2.innerHTML = `<input class="inputElem" id="gridCost${newId}" type="number" min="0" max="100000" step="1" value="${price}" onchange="limitElement(this);gridCost[${newId-1}].price=this.value;displaySaveHint()">`;
        updateMaxPowerElement(document.getElementById(`gridLimit${newId}`), newId);
      }

      function removeMaxPowerElement() {
        let table = document.getElementById('gridCostsTable');
        if (gridCost.length <= 1) return;
        gridCost.pop();
        table.deleteRow(-1);
        let objectAtBottom = document.getElementById(`gridLimit${gridCost.length}`);
        if (objectAtBottom) objectAtBottom.max = 100000;
        updateMaxPowerList();
      }

      function updateMaxPowerElement(object, id) {
        limitElement(object);
        gridCost[id-1].limit = object.value;
        let objectAbove = document.getElementById(`gridLimit${id-1}`);
        if (objectAbove) objectAbove.max = object.value;
        let objectBelow = document.getElementById(`gridLimit${id+1}`);
        if (objectBelow) objectBelow.min = object.value;
        updateMaxPowerList();
      }

      function limitElement(object) {
        if ((object.value === "") || (Number.isNaN(+object.value))) {
          object.value = 0;
        }
        if(+object.value < parseInt(object.min)){
          object.value = +object.min;
        } else if(+object.value > parseInt(object.max)){
          object.value = +object.max;
        }
      }

      function setFrostTemp(object, device_id) {
        if(object.value != "") {
          limitElement(object);
          frostList[device_id]['minTemp'] = object.value
        }
      }

      function setDeltaTemp(object, price_point, deviceId) {
        if(object.value != "") {
          limitElement(object);
          priceActionList[price_point][deviceId]['delta'] = object.value
        }
      }

      function setTargetTemp(object, listNum, device_id) {
        if(object.value != "") {
          limitElement(object);
          modeList[listNum][device_id]['targetTemp'] = object.value
        }
      }

      function setModeName(object, mode) {
        if (object.value != "") {
          modeNames[mode] = object.value;
          needModeRefresh = true;
        }
      }

      function setVisible(id, type = 'table-row') {
        var element = document.getElementById(id);
        element.style.display = type;
      }

      function isChargerControllable() {
        for (var key in deviceList) {
          var device = deviceList[key];
          if ((device.use) && (device.driverId in DEVICE_CMD) && (DEVICE_CMD[device.driverId].type === DEVICE_TYPE.CHARGER)) {
            return true;
          }
        }
        return false;
      }

      function changeTaskVisibility(taksName, makeVisible) {
        if (makeVisible) {
          setVisible(taksName);
        } else {
          setVisible(taksName, 'none');
        }
        return makeVisible;
      }

      function refreshTodoList() {
        let experimentalEnabled = false;
        for (var key in deviceList) {
          var device = deviceList[key];
          var experimental = !(device.driverId in DEVICE_CMD) || ("beta" in DEVICE_CMD[device.driverId]);
          experimentalEnabled |= device.use && experimental;
        }
        let appIsDisabled = (document.getElementById("appEnabled").value == '0');
        let haveTasks = false;
        const { foundCharger, chargerUsed } = checkForCharger(deviceList);
        const priceMode = document.getElementById("priceMode").value;
        const priceKind = document.getElementById("priceKind").value;
        haveTasks |= changeTaskVisibility('taskEnableApp', appIsDisabled);
        haveTasks |= changeTaskVisibility('taskCreateEnergyFlow', !appIsDisabled && appConfigProgress.energyMeterNotConnected);
        haveTasks |= changeTaskVisibility('taskEnergyFlowRate', !appIsDisabled && !appConfigProgress.energyMeterNotConnected && (+appConfigProgress.timeSinceEnergyMeter > 120));
        haveTasks |= changeTaskVisibility('taskChargerNotEnabled', !appIsDisabled && (+document.getElementById('chargeTarget').value == CHARGE_TARGET_AUTO) && (!isChargerControllable()) && (new Date(chargerOptions.chargeEnd) > new Date()));
        haveTasks |= changeTaskVisibility('taskNoPriceFlow', !appIsDisabled && priceMode == PRICE_MODE_FLOW && !appConfigProgress.gotPPFromFlow);
        haveTasks |= changeTaskVisibility('taskNoPriceAPI', !appIsDisabled && priceMode == PRICE_MODE_INTERNAL && priceKind == PRICE_KIND_EXTERNAL && appConfigProgress.ApiStatus == PRICE_API_NO_APP);
        haveTasks |= changeTaskVisibility('taskNoPriceAPIDevice', !appIsDisabled && priceMode == PRICE_MODE_INTERNAL && priceKind == PRICE_KIND_EXTERNAL && appConfigProgress.ApiStatus == PRICE_API_NO_DEVICE);
        haveTasks |= changeTaskVisibility('taskNoPriceAPIData', !appIsDisabled && priceMode == PRICE_MODE_INTERNAL && priceKind == PRICE_KIND_EXTERNAL && appConfigProgress.ApiStatus == PRICE_API_NO_DATA);
        haveTasks |= changeTaskVisibility('taskNoPriceEnabled', !appIsDisabled && priceMode == PRICE_MODE_DISABLED);
        haveTasks |= changeTaskVisibility('taskNoPrices', !appIsDisabled && priceMode == PRICE_MODE_INTERNAL && priceKind == PRICE_KIND_SPOT && noPrices);
        haveTasks |= changeTaskVisibility('taskDisableLogging', !appIsDisabled && isLoggingEnabled());
        haveTasks |= changeTaskVisibility('taskExperimental', !appIsDisabled && experimentalEnabled);
        haveTasks |= changeTaskVisibility('taskSpookey', !appIsDisabled && (+appConfigProgress.numSpookeyChanges > 0));
        haveTasks |= changeTaskVisibility('errorDevices', !appIsDisabled && numErrorDevices > 0);
        haveTasks |= changeTaskVisibility('taskAddCarCharger', !appIsDisabled && foundCharger && !chargerUsed);
        changeTaskVisibility('taskNone', !haveTasks);
      }

      function refreshDeviceSelector(devices) {
        const devSel = document.getElementById("deviceInfoSelector");
        var selectedPoint = 0
        var options = '';
        for (var i = 0; i < devices.length; i++) {
          options += '<option value="' + devices[i].value + '" '
            + ((selectedPoint==i) ? 'selected' : '') + '>' + devices[i].name + '</option>';
        }
        devSel.innerHTML = options;
      }
    </script>
  </head>


  <body class="noMargin">
    <!--
    <h1 data-i18n="settings.title">.title</h1>
    <p data-i18n="settings.subtitle">.subtitle</p>
    <div id="debug">blah...</div>
    -->
    <!-- Loading page-->
    <div id="loadingPage">
    <div data-i18n="settings.loadingText" id="loadingText">loadingText</div>
    <p><div data-i18n="settings.sponsoredBy" id="sponsoredByText">sponsoredBy</div></p>
    <div data-i18n="settings.sponsorText" id="sponsorText">sponsorText</div>
    </div>

    <!-- Saving overlay -->
    <div id="savingOverlay">
      <div class="center">
        <b>
          <div class="spinner">!</div>
          <span class="anim-text" data-i18n="warnings.savingWait"></span>
        </b>
      </div>
    </div>

    <!-- Menu -->
    <table id="main_menu" class="menu" style="display:none;">
      <tbody class="menuitem">
      <tr>
        <td onclick="changeTab(event, 'welcomePage')">
          <a href="#home" data-i18n="settings.menu.home.title">Home</a>
        </td>
        <td class="dropdown" onclick="allowDropdown();">
          <a href="javascript:void(0)" class="dropbtn" data-i18n="settings.menu.devices.title">Devices</a>
          <div class="dropdown-content">
            <a href="#" data-i18n="settings.menu.devices.meterReader" onclick="changeTab(event, 'meterPage')">Meter Reader</a>
            <a href="#" data-i18n="settings.menu.devices.controllable" onclick="changeTab(event, 'devicePage')">Controllable devices</a>
            <a href="#" data-i18n="settings.menu.devices.modes" onclick="changeTab(event, 'priorityPage', 0)">Modes and priority</a>
            <a href="#" data-i18n="settings.menu.devices.prices" onclick="changeTab(event, 'pricePage')">Price points</a>
          </div>
        </td>
        <td id="advancedMenu" class="dropdown" onclick="allowDropdown();">
          <a href="javascript:void(0)" class="dropbtn" data-i18n="settings.menu.advanced.title">Advanced</a>
          <div id="advancedMenuDrop" class="dropdown-content">
            <a id="priceLink" href="#" data-i18n="settings.menu.advanced.cost" onclick="changeTab(event, 'costPage')">Price settings</a>
            <a href="#" data-i18n="settings.menu.advanced.settings" onclick="changeTab(event, 'advancedPage')">Advanced settings</a>
            <a href="#" data-i18n="settings.menu.advanced.charger" onclick="changeTab(event, 'chargerPage')">Car Chargers</a>
            <a href="#" data-i18n="settings.menu.advanced.frost" onclick="changeTab(event, 'frostPage')">Frost guard</a>
            <a href="#" data-i18n="settings.menu.advanced.override" onclick="changeTab(event, 'overridePage')">Override</a>
            <a href="#" data-i18n="settings.menu.advanced.backup" onclick="changeTab(event, 'backupPage')">Backup</a>
            <a href="#" data-i18n="settings.menu.advanced.timetable" onclick="changeTab(event, 'schedulePage')">Time Schedules</a>
          </div>
        </td>
        <td class="dropdown" style="text-align:right" onclick="allowDropdown();">
          <a href="javascript:void(0)" class="dropbtn" data-i18n="settings.menu.help.title">Help</a>
          <div class="dropdown-content" style="position:fixed;right:0">
            <a href="#" data-i18n="settings.menu.help.wiz" onclick="changeTab(event, 'wizzardPage')">Wizzard</a>
            <a href="#" data-i18n="settings.menu.help.notfound" onclick="changeTab(event, 'helpNotFoundPage')">Not Found</a>
            <a href="#" data-i18n="settings.menu.help.fixarchive" onclick="changeTab(event, 'fixArchivePage')">Fix Archive</a>
            <a href="#" data-i18n="settings.menu.help.debug" onclick="debugMode=true;changeTab(event, 'logPage')">Debug</a>
            <a href="#" data-i18n="settings.menu.help.supported" onclick="changeTab(event, 'helpSupportedPage')">Supported Devices</a>
            <a href="#" data-i18n="settings.menu.help.about" onclick="changeTab(event, 'helpAboutPage')">About</a>
          </div>
        </td>
      </tr>
    </tbody>
    </table>

    <div style="padding:16px;margin-top:16px;height:0px;"></div>

    <!-- Important information is shown here -->
    <div data-i18n="warnings.rememberToSave" id="rememberToSave">Remember to save</div>

    <!-- Welcome page -->
    <div id="welcomePage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.mode.powerSettings">mode.powerSettings</legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="appEnabled" data-i18n="settings.app.activeted">app.activeted</label>:</td>
            <td class="settings_row_input">
              <select id="appEnabled" onchange="displaySaveHint();refreshTodoList();">
                <option value="0" selected data-i18n="settings.app.disabled">App Disabled</option>
                <option value="1" data-i18n="settings.app.enabled">App Enabled</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'activationHint1');toggle(this,'activationHint2');return false;">i</div>
            </td>
          </tr>
          <tr>
            <td class="settings_row_name"><label data-i18n="settings.mode.limits">mode.limits</label>:</td>
            <td class="settings_row_input"><label style="vertical-align: top" id="limitsDuplicate">limits</label>
              <div class="edit icon" style="transform: translate(0px, -3px)" onclick="runActionQueue(wizGotoLimiters);"></div>
            </td>
          </tr>
        </table>
        <p id="activationHint1" class="hint" data-i18n="settings.app.activationHint1">app.activationHint1</p>
        <p id="activationHint2" class="hint" data-i18n="settings.app.activationHint2">app.activationHint2</p>

      </fieldset>

      <table width="100%" class="tab">
        <tr>
          <td class="subtablinks" id="maxHourButton">
            <span data-i18n="graph.maxhour">graph.maxhour</span>
          </td>
          <td class="subtablinks" id="consumptionButton">
            <span data-i18n="graph.consumption">graph.consumption</span>
          </td>
          <td class="subtablinks" id="pricesButton">
            <span data-i18n="graph.prices">graph.prices</span>
          </td>
          <!--td class="subtablinks" id="savingsButton">
            <span data-i18n="graph.savings">graph.savings</span>
          </td-->
        </tr>
      </table>

      <div style="background-color:#a0d0d6;">
        <div style="text-align:center; padding: 2px;">
          <button id="ltButton">&lt;</button>
          <button id="dayButton" data-i18n="graph.day">Day</button>
          <button id="monthButton" data-i18n="graph.month">Month</button>
          <button id="yearButton" data-i18n="graph.year">Year</button>
          <button id="gtButton">&gt;</button>
        </div>


        <canvas id="tariffGuideChart" style="max-height:250px;min-height:250px;display:none"></canvas>
      </div>

      <fieldset>
        <legend data-i18n="settings.app.myTasks">app.myTasks</legend>

        <table class="settings_table">
          <tr id="taskCreateEnergyFlow"><td style="vertical-align:top;"><img class="alert" src="error.png"></td><td><span data-i18n="settings.welcome.taskCreateEnergyFlow">taskCreateEnergyFlow</span></td></tr>
          <tr id="taskNoPriceAPI"><td style="vertical-align:top;"><img class="alert" src="error.png"></td><td><span data-i18n="settings.welcome.taskNoPriceAPI">taskNoPriceAPI</span></td></tr>
          <tr id="taskNoPriceAPIDevice"><td style="vertical-align:top;"><img class="alert" src="error.png"></td><td><span data-i18n="settings.welcome.taskNoPriceAPIDevice">taskNoPriceAPIDevice</span></td></tr>
          <tr id="taskNoPriceAPIData"><td style="vertical-align:top;"><img class="alert" src="error.png"></td><td><span data-i18n="settings.welcome.taskNoPriceAPIData">taskNoPriceAPIData</span></td></tr>
          <tr id="taskChargerNotEnabled"><td style="vertical-align:top;"><img class="alert" src="error.png"></td><td><span data-i18n="settings.welcome.taskChargerNotEnabled">taskChargerNotEnabled</span></td></tr>
          <tr id="taskNoPrices"><td style="vertical-align:top;"><img class="alert" src="error.png"></td><td><span data-i18n="settings.welcome.taskNoPrices">taskNoPrices</span></td></tr>
          <tr id="taskEnableApp"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span data-i18n="settings.welcome.taskEnableApp">taskEnableApp</span></td></tr>
          <tr id="taskEnergyFlowRate"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span id="energyFlowRateText">taskEnergyFlowRate</span></td></tr>
          <tr id="taskNoPriceFlow"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span data-i18n="settings.welcome.taskNoPriceFlow">taskNoPriceFlow</span></td></tr>
          <tr id="taskDisableLogging"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span data-i18n="settings.welcome.taskDisableLogging">taskDisableLogging</span></td></tr>
          <tr id="taskExperimental"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span data-i18n="settings.welcome.taskExperimental">taskExperimental</span></td></tr>
          <tr id="taskSpookey"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span id="spookeyText">taskSpookey</span></td></tr>
          <tr id="errorDevices"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span data-i18n="settings.welcome.errorDevices">errorDevices</span><div id="errorDeviceList"></div></td></tr>
          <tr id="taskAddCarCharger"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span data-i18n="settings.charge.carChargerNotAddedHint">charge.carChargerNotAddedHint</span></td></tr>
          <tr id="taskNoPriceEnabled"><td style="vertical-align:top;"><img class="alert" src="info.png"></td><td><span data-i18n="settings.welcome.taskNoPriceEnabled">taskNoPriceEnabled</span></td></tr>
          <tr id="taskNone"><td style="vertical-align:top;"><img class="alert" src="info.png"></td><td><span data-i18n="settings.welcome.taskNone">taskNone</span></td></tr>
        </table>

      </fieldset>

    </div>

    <!-- First time Wizzard page -->
    <div id="wizzardPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.wizzard.welcome">wizzard.welcome</legend>
        <p data-i18n="settings.wizzard.guide">wizzard.guide</p>
      </fieldset>
    </div>

    <!-- Help page: Device not found -->
    <div id="helpNotFoundPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.notFound">help.notFound</legend>
        <p data-i18n="settings.help.notFoundHint">help.notFoundHint</p>
        <a href="#ShowLog" data-i18n="settings.log.show" onclick="debugMode=false;changeTab(event, 'logPage');return false;">log.show</a>
      </fieldset>
    </div>

    <!-- Fix archive page -->
    <div id="fixArchivePage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.menu.help.fixarchive">help.fixarchive</legend>
        <p data-i18n="settings.archive.fixHint">archive.fixHint</p>
        <table>
          <tr>
            <th><span data-i18n="settings.archive.fixParameter">Parameter</span>:</th>
            <td>
              <select id="archiveParam">
                <option value="" selected>-</option>
                <option value="maxPower">maxPower</option>
                <option value="dataOk">dataOk</option>
                <option value="powUsage">powUsage</option>
                <option value="charged">charged</option>
                <option value="moneySavedTariff">moneySavedTariff</option>
                <option value="moneySavedUsage">moneySavedUsage</option>
                <option value="price">price</option>
                <option value="pricePoints">pricePoints</option>
                <option value="subsidy">subsidy</option>
                <option value="overShootAvoided">overShootAvoided</option>
                <option value="cost">cost</option>
              </select>
            </td>
          </tr>
          <tr>
            <th><span data-i18n="settings.archive.fixTimespan">Timespan</span>:</th>
            <td>
              <select id="archiveTimespan">
                <option value="" selected>-</option>
                <option value="yearly">Yearly samples</option>
                <option value="monthly">Monthly samples</option>
                <option value="daily">Daily samples</option>
                <option value="hourly">Hourly sampels</option>
                <option value="quarter">15 minutes samples</option>
              </select>
            </td>
          </tr>
          <tr>
            <th><span data-i18n="settings.archive.fixSlot">Slot</span>:</th>
            <td>
              <select id="archiveSlot" disabled>
                <option value="" >...</option>
              </select>
            </td>
          </tr>
          <tr id="archiveItemRow" style="display: none;">
            <th><span data-i18n="settings.archive.fixItem">Item</span>:</th>
            <td>
              <select id="archiveItem">
                <option value="" >...</option>
              </select>
            </td>
          </tr>
          <tr>
            <th><span data-i18n="settings.archive.fixValue">Value</span>:</th>
            <td><input id="archiveValue" type="text" value="N/A" disabled></td>
          </tr>
          <tr>
            <th></th>
            <td><button id="archiveButton" data-i18n="settings.archive.fixSubmit" disabled>.fixSubmit</button></td>
          </tr>
        </table>
        <div id="archiveFeedback"></div>
      </fieldset>
    </div>

    <!-- Help page: Supported Devices -->
    <div id="helpSupportedPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.supportedDevices">help.supportedDevices</legend>
        <div id="supportedDevicesList">This list should have been populated by supported devices, if you can see this text it is a bug.</div><br>
        <p data-i18n="settings.help.supportedDevicesHint">help.supportedDevicesHint</p>
        <a href="#ShowLog" data-i18n="settings.global.problemsolver" onclick="changeTab(event, 'helpNotFoundPage');return false;">global.problemsolver</a>
      </fieldset>
    </div>

    <!-- Help page: About -->
    <div id="helpAboutPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.aboutInfo">help.aboutInfo</legend>
        <p data-i18n="settings.help.aboutInfoHint">help.aboutInfoHint</p>
      </fieldset>
    </div>

    <!-- Meter reader page -->
    <div id="meterPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.meter.title">meter.title</legend>
        <p id="meterReaderNotFound" class="hint" data-i18n="settings.meter.meterReaderNotFound">meter.meterReaderNotFound</p>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="meterReader" data-i18n="settings.meter.meterReader">meter.meterReader</label>:</td>
            <td class="settings_row_input">
              <select id ="meterReader" onchange="displaySaveHint();">
                <option value="0" selected>Error - should be replaced with meter readers</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'meterReaderHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="meterReaderHint" class="hint"><td colspan="2"><p data-i18n="settings.meter.meterReaderHint">meter.meterReaderHint</p></td></tr>

          <tr>
            <td class="settings_row_name"><label for="meterFrequency" data-i18n="settings.meter.frequency">meter.frequency</label>:</td>
            <td class="settings_row_input"><input id="meterFrequency" type="number" min="10" max="60" value="10" onchange="limitElement(this);displaySaveHint()">s 
              <div class="hintButton" onclick="toggle(this,'meterFrequencyHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="meterFrequencyHint" class="hint"><td colspan="2"><p data-i18n="settings.meter.frequencyHint">meter.frequencyHint</p></td></tr>

          <tr>
            <td class="settings_row_name"><label for="errorMargin" data-i18n="settings.global.errorMargin">global.errorMargin</label>:</td>
            <td class="settings_row_input"><input id="errorMargin" type="number" min="0" max="30" value="5" onchange="displaySaveHint()">% 
              <div class="hintButton" onclick="toggle(this,'hintEm', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="hintEm" class="hint"><td colspan="2">
            <p data-i18n="settings.global.errorMarginHint1">global.errorMarginHint1</p>
            <p data-i18n="settings.global.errorMarginHint2">global.errorMarginHint2</p></td>
          </tr>

          <tr>
            <td class="settings_row_name"><label for="safetyPower" data-i18n="settings.global.safetyPower">global.safetyPower</label>:</td>
            <td class="settings_row_input"><input id="safetyPower" type="number" min="0" max="100000" step="100" value="500" onchange="displaySaveHint()">W 
              <div class="hintButton" onclick="toggle(this,'hint3', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="hint3" class="hint"><td colspan="2">
            <p data-i18n="settings.global.safetyPowerHint1">global.safetyPowerHint1</p>
            <p data-i18n="settings.global.safetyPowerHint2">global.safetyPowerHint2</p></td>
          </tr>

          <tr>
            <td class="settings_row_name"><label for="crossSlotSmooth" data-i18n="settings.global.crossSlotSmooth">global.crossSlotSmooth</label>:</td>
            <td class="settings_row_input"><input id="crossSlotSmooth" type="number" min="0" max="100" step="100" value="20" onchange="displaySaveHint()">%
              <div class="hintButton" onclick="toggle(this,'crossSlotSmoothHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="crossSlotSmoothHint" class="hint"><td colspan="2"><p data-i18n="settings.global.crossSlotSmoothHint">global.crossSlotSmoothHint</p></td></tr>
        </table>
      </fieldset>
    </div>

    <!-- Cost page -->
    <div id="costPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.cost.header">cost.header</legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="priceCountry" data-i18n="settings.price.spotPrice.country">spotPrice.country</label>:</td>
            <td class="settings_row_input">
              <select id="priceCountry" onchange="updateRegions(this.value, futurePriceOptions.priceRegion);changeSchema(this.value, this.value);displaySaveHint()">
                <option value="0" selected>Country selector</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'countryHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="countryHint" class="hint"><td colspan="2"><p data-i18n="settings.global.countryHint">global.countryHint</p></td></tr>
          <tr id="costSchemaBox">
            <td class="settings_row_name"><label for="costSchema" data-i18n="settings.cost.schema">cost.schema</label>:</td>
            <td class="settings_row_input">
              <select id="costSchema" onchange="changeSchema(document.getElementById('priceCountry').value, this.value);displaySaveHint()">
                <option value="0" selected>Controller Schema</option>
              </select>
            </td>
          </tr>
          <tr>
            <td class="settings_row_name"><label for="currency" data-i18n="settings.cost.currency">cost.currency</label>:</td>
            <td class="settings_row_input">
              <select id ="currency" onchange="displaySaveHint();">
                <option value="0" selected>Error - should be replaced with currencies</option>
              </select>
            </td>
          </tr>
          <tr>
            <td class="settings_row_name"><label for="VAT" data-i18n="settings.cost.VAT">cost.VAT</label>:</td>
            <td class="settings_row_input"><input id="VAT" class="inputElem" type="number" min="0" max="100" value="25" onchange="displaySaveHint()">%</td>
          </tr>
        </table>
      </fieldset>

      <input id="collapsible2" class="toggle" type="checkbox">
      <label for="collapsible2" class="lbl-toggle" data-i18n="settings.price.usagePart" style="color: whitesmoke;">price.usagePart</label>
      <div class="collapsible-content"><div class="content-inner">
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="priceKind" data-i18n="settings.price.priceKind">price.priceKind</label>:</td>
            <td class="settings_row_input">
              <select id="priceKind" onchange="checkPriceKind();displaySaveHint()">
                <option value="1" data-i18n="settings.price.priceKindSpot" selected>Spot price</option>
                <option value="2" data-i18n="settings.price.priceKindFixed">Fixed price</option>
                <option id="priceKindOptionUtil" value="0" data-i18n="settings.price.priceKindUtil">UtilityCost</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'hintPriceKind', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="hintPriceKind" class="hint"><td colspan="2"><p data-i18n="settings.price.priceKindHint">price.priceKindHint</p></td></tr>
          <tr id="errp1" class="error"><td colspan="2"><p data-i18n="settings.price.priceErr1">price.priceErr1</p></td></tr>
          <tr id="regionPart">
            <td class="settings_row_name"><label for="priceRegion" data-i18n="settings.price.spotPrice.region">spotPrice.region</label>:</td>
            <td class="settings_row_input">
              <select id="priceRegion" onchange="displaySaveHint()">
                <option value="0" selected>Region selector</option>
              </select>
            </td>
          </tr>
      </table>

        <span id="priceSpotPart" style="display: none">
          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="surcharge" data-i18n="settings.cost.surcharge">cost.surcharge</label>:</td>
              <td class="settings_row_input"><input id="surcharge" class="inputElem" type="number" value="0" step="0.01" onchange="displaySaveHint()">/kWh</td>
            </tr>
          </table>
        </span>

        <span id="priceFixedPart" style="display: none">
          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="priceFixed" data-i18n="settings.price.fixed">price.fixed</label>:</td>
              <td class="settings_row_input"><input id="priceFixed" class="inputElem" type="number" size="10" min="0" step="0.01" value="0.50" onchange="displaySaveHint()">/kWh</td>
            </tr>
          </table>
        </span>

        <span id="priceFixedAndSpotPart" style="display: none">
          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="gridTaxDay" data-i18n="settings.cost.gridTaxDay">cost.gridTaxDay</label>:</td>
              <td class="settings_row_input"><input id="gridTaxDay" class="inputElem" type="number" min="0" value="0.3626" onchange="displaySaveHint()">/kWh</td>
            </tr>
            <tr>
              <td class="settings_row_name"><label for="gridTaxNight" data-i18n="settings.cost.gridTaxNight">cost.gridTaxNight</label>:</td>
              <td class="settings_row_input"><input id="gridTaxNight" class="inputElem" type="number" min="0" value="0.2839" onchange="displaySaveHint()">/kWh</td>
            </tr>
            <tr id="peakStartEn">
              <td class="settings_row_name"><label for="peakStart" data-i18n="settings.cost.peakStart">cost.peakStart</label>:</td>
              <td class="settings_row_input"><input id="peakStart" class="inputElem" type="time" value="07:00" pattern="[0-9]{2}:[0-9]{2}" onchange="displaySaveHint()"></td>
            </tr>
            <tr id="peakEndEn">
              <td class="settings_row_name"><label for="peakEnd" data-i18n="settings.cost.peakEnd">cost.peakEnd</label>:</td>
              <td class="settings_row_input"><input id="peakEnd" class="inputElem" type="time" value="22:00" pattern="[0-9]{2}:[0-9]{2}" onchange="displaySaveHint()"></td>
            </tr>
            <tr id="peakWeekendEn">
              <td class="settings_row_name"><label for="weekendOffPeak" data-i18n="settings.cost.weekendOffPeak">cost.weekendOffPeak</label>:</td>
              <td class="settings_row_input"><input id="weekendOffPeak" type="checkbox" onchange="displaySaveHint()"></td>
            </tr>
          </table>

          <span id="subsidyPart" style="display: block">
            <table class="settings_table">
              <tr id="subsidyEn">
                <td class="settings_row_name"><label for="govSubsidy" data-i18n="settings.cost.govSubsidy">cost.govSubsidy</label>:</td>
                <td class="settings_row_input"><input id="govSubsidy" type="checkbox" onchange="checkPriceKind();refreshSchema();displaySaveHint()">
                  <div class="hintButton" onclick="toggle(this,'hintSubsidy', 'table-row');return false;">i</div>
                </td>
              </tr>
              <tr id="hintSubsidy" class="hint"><td colspan="2"><p data-i18n="settings.cost.govSubsidyHint">cost.govSubsidyHint</p></td></tr>
              <tr id="subsidyThreshold">
                <td class="settings_row_name"><label for="govSubsidyThreshold" data-i18n="settings.cost.govSubsidyThreshold">cost.govSubsidyThreshold</label>:</td>
                <td class="settings_row_input"><input id="govSubsidyThreshold" class="inputElem" type="number" min="0" value="0.70" step="0.01" onchange="displaySaveHint()">/kWh</td>
              </tr>
              <tr id="subsidyRate">
                <td class="settings_row_name"><label for="govSubsidyRate" data-i18n="settings.cost.govSubsidyRate">cost.govSubsidyRate</label>:</td>
                <td class="settings_row_input"><input id="govSubsidyRate" class="inputElem" type="number" min="0" max="100" value="90" step="1" onchange="displaySaveHint()">%</td>
              </tr>
            </table>
          </span>
        </span>
      </div></div>

      <input id="collapsible3" class="toggle" type="checkbox">
      <label for="collapsible3" class="lbl-toggle" data-i18n="settings.price.powerPart" style="color: whitesmoke;">price.powerPart</label>
      <div class="collapsible-content"><div class="content-inner">
        <table class="settings_table">
          <tr id="granularityEn">
            <td class="settings_row_name"><label for="granularity" data-i18n="settings.cost.granularity">cost.granularity</label>:</td>
            <td class="settings_row_input">
              <select id="granularity" onchange="refreshSchema();displaySaveHint()">
                <option value="15" data-i18n="settings.cost.granularity15">15 min</option>
                <option value="60" data-i18n="settings.cost.granularity60" selected>60 min</option>
              </select></td>
          </tr>
          <tr id="gridStepEn">
            <td class="settings_row_name"><label for="gridSteps" data-i18n="settings.cost.gridSteps">cost.gridSteps</label>:</td>
            <td class="settings_row_input"><input id="gridSteps" type="checkbox" checked onchange="refreshSchema();displaySaveHint()"></td>
          </tr>
        </table>
        <div id="gridLinearBlock">
          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="peakMin" data-i18n="settings.cost.peakMin">cost.peakMin</label>:</td>
              <td class="settings_row_input"><input id="peakMin" class="inputElem" type="number" min="0" value="2500" onchange="displaySaveHint()">Wh/h</td>
            </tr>
            <tr>
              <td class="settings_row_name"><label for="peakTax" data-i18n="settings.cost.peakTax">cost.peakTax</label>:</td>
              <td class="settings_row_input"><input id="peakTax" class="inputElem" type="number" min="0" value="0.2839" onchange="displaySaveHint()">/MWh</td>
            </tr>
          </table>
        </div>
        <div id="gridStepBlock">
        <p data-i18n="settings.cost.gridLimitHint">cost.gridLimitHint</p>
        <table id = "gridCostsTable" class="settings_table">
          <tr>
            <th class="settings_row_input"><label for="gridLimit1" data-i18n="settings.cost.gridLimit">cost.gridLimit</label></th>
            <th class="settings_row_input"><label for="gridCost1" data-i18n="settings.cost.gridCost">cost.gridCost</label></th>
          </tr>
        </table>
        <input type="button" value="-" onclick="removeMaxPowerElement();">
        <input type="button" value="+" onclick="addMaxPowerElement();">
        </div>
      </div></div>

      <input id="collapsible4" class="toggle" type="checkbox">
      <label for="collapsible4" class="lbl-toggle" data-i18n="settings.price.limitPart" style="color: whitesmoke;">price.limitPart</label>
      <div class="collapsible-content"><div class="content-inner">
        <table id="maxPowerTable" class="settings_table">
          <tr>
            <th class="settings_row_name">&nbsp;</th>
            <th class="settings_row_en" data-i18n="settings.cost.enabled">cost.enabled</th>
            <th class="settings_row_input"><span data-i18n="settings.cost.limit">cost.limit</span>
              <div class="hintButton" onclick="toggle(this,'maxPowHint', 'table-row');return false;">i</div>
            </th>
          </tr>
          <tr id="enLimit15Box">
            <td class="settings_row_name"><label for="maxPower15min" data-i18n="settings.mode.maxPower15min">mode.maxPower15min</label>:</td>
            <td class="settings_row_en"><input id="enLimit15" type="checkbox" onchange="refreshSchema();displaySaveHint()"></td>
            <td class="settings_row_input"><input class="inputElem" id="maxPower15min" type="number" min="10" max="25000" value="1000" onchange="limitElement(this);displaySaveHint()">Wh/15 min.</td>
          </tr>
          <tr id="enLimit60Box">
            <td class="settings_row_name"><label for="maxPowerHour" data-i18n="settings.mode.maxPowerHour">mode.maxPowerHour</label>:</td>
            <td class="settings_row_en"><input id="enLimit60" type="checkbox" onchange="refreshSchema();displaySaveHint()"></td>
            <td class="settings_row_input">
              <div id="enLimit60InBox">
                <input class="inputElem" id="maxPowerHour" type="number" min="10" max="100000" value="1000" onchange="setMaxPowerHour(this.value,1000,100000);displaySaveHint()">Wh/hour
              </div>
              <div id="enLimit60SelBox">
              <select id ="maxPowerList" onchange="setMaxPowerHour(this.value,1000,100000);displaySaveHint();">
                <option value="0" selected>Error - should be replaced with max power</option>
              </select>
              <div class="edit icon" onclick="document.getElementById('collapsible3').checked = true;flashElement('gridCostsTable')"></div>
              </d    iv>
            </td>
          </tr>
          <tr>
            <td class="settings_row_name"><label for="maxPowerDay" data-i18n="settings.mode.maxPowerDay">mode.maxPowerDay</label>:</td>
            <td class="settings_row_en"><input id="enLimitDay" type="checkbox" onchange="refreshSchema();displaySaveHint()"></td>
            <td class="settings_row_input"><input id="maxPowerDay" type="number" min="10" max="1000" value="1000" onchange="limitElement(this);displaySaveHint()">kWh/day</td>
          </tr>
          <tr>
            <td class="settings_row_name"><label for="maxPowerMonth" data-i18n="settings.mode.maxPowerMonth">mode.maxPowerMonth</label>:</td>
            <td class="settings_row_en"><input id="enLimitMonth" type="checkbox" onchange="refreshSchema();displaySaveHint()"></td>
            <td class="settings_row_input"><input id="maxPowerMonth" type="number" min="50" max="50000" value="5000" step="1" onchange="limitElement(this);displaySaveHint()">kWh/month</td>
          </tr>
          <tr id="maxPowHint" class="hint"><td colspan="3"><p data-i18n="settings.app.maxPowHint">app.maxPowHint</p></td></tr>
          <tr>
            <td class="settings_row_name"><label for="maxAlarmRate" data-i18n="settings.mode.maxAlarmRate">mode.maxAlarmRate</label>:</td>
            <td class="settings_row_en"><input id="enLimitMissing" type="checkbox" checked onchange="refreshSchema();displaySaveHint();elem = document.getElementById('maxAlarmRate'); if (this.checked) elem.value = 50; else elem.value=0;"></td>
            <td class="settings_row_input"><input id="maxAlarmRate" type="number" min="0" max="100" step="100" value="20" onchange="displaySaveHint()">%
              <div class="hintButton" onclick="toggle(this,'maxAlarmRateHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="maxAlarmRateHint" class="hint"><td colspan="3"><p data-i18n="settings.app.maxAlarmRateHint">app.maxAlarmRateHint</p></td></tr>
        </table>
      </div></div>
    </div>

    <!-- Advanced page -->
    <div id="advancedPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.global.settings">global.settings</legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="mainFuse" data-i18n="settings.global.mainFuse">global.mainFuse</label>:</td>
            <td class="settings_row_input"><input id="mainFuse" type="number" min="0" max="100000" value="63" onchange="displaySaveHint()">A 
              <div class="hintButton" onclick="toggle(this,'mainFuseHint');return false;">i</div>
            </td>
          </tr>
        </table>
        <p id="mainFuseHint" class="hint" data-i18n="settings.global.mainFuseHint">global.mainFuseHint</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="freeThreshold" data-i18n="settings.global.freeThreshold">global.freeThreshold</label>:</td>
            <td class="settings_row_input"><input id="freeThreshold" type="number" min="0" max="100" value="100" onchange="displaySaveHint()">% 
              <div class="hintButton" onclick="toggle(this,'freeThresholdHint');return false;">i</div>
            </td>
          </tr>
        </table>
        <p id="freeThresholdHint" class="hint" data-i18n="settings.global.freeThresholdHint">global.freeThresholdHint</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="toggleTime" data-i18n="settings.global.toggleTime">global.toggleTime</label>:</td>
            <td class="settings_row_input"><input id="toggleTime" type="number" min="5" max="60" value="10" onchange="limitElement(this);displaySaveHint()">s 
              <div class="hintButton" onclick="toggle(this,'toggleTimeHint');return false;">i</div>
            </td>
          </tr>
        </table>
        <p id="toggleTimeHint" class="hint" data-i18n="settings.global.toggleTimeHint">global.toggleTimeHint</p>
      </fieldset>
      <fieldset>
        <legend data-i18n="settings.archive.settings">archive.settings</legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="expireDaily" data-i18n="settings.archive.expireDaily">archive.expireDaily</label>:</td>
            <td class="settings_row_input"><input id="expireDaily" type="number" min="31" max="365" value="62" onchange="displaySaveHint()"> 
              <div class="hintButton" onclick="toggle(this,'expireHint');return false;">i</div>
            </td>
          </tr>
          <tr>
            <td class="settings_row_name"><label for="expireHourly" data-i18n="settings.archive.expireHourly">archive.expireHourly</label>:</td>
            <td class="settings_row_input"><input id="expireHourly" type="number" min="1" max="31" value="7" onchange="displaySaveHint()"> 
              <div class="hintButton" onclick="toggle(this,'expireHint');return false;">i</div>
            </td>
          </tr>
        </table>
        <p id="expireHint" class="hint" data-i18n="settings.archive.expireHint">archive.expireHint</p>
      </fieldset>
    </div>

    <!-- Advanced page: Car Chargers -->
    <div id="chargerPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.charge.header">charge.header</legend>
        <table class="settings_table">
          <tr id="carChargerMissingHint"><td style="vertical-align:top;"><img class="alert" src="info.png"></td><td><span data-i18n="settings.charge.carChargerMissingHint">charge.carChargerMissingHint</span></td></tr>
          <tr id="carChargerNotAddedHint"><td style="vertical-align:top;"><img class="alert" src="warning.png"></td><td><span data-i18n="settings.charge.carChargerNotAddedHint">charge.carChargerNotAddedHint</span></td></tr>
        </table>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="chargeTarget" data-i18n="settings.charge.chargeTarget">charge.chargeTarget</label>:</td>
            <td class="settings_row_input">
              <select id="chargeTarget" disabled class="inputElem" onchange="updateAdvancedSettings();displaySaveHint()">
                <option value="1" data-i18n="settings.charge.chargeTargetAuto" selected >Auto</option>
                <option value="2" data-i18n="settings.charge.chargeTargetFlow">Manual</option>
              </select> <div class="hintButton" onclick="toggle(this,'chargeTargetHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="chargeTargetHint" class="hint"><td colspan="2"><p data-i18n="settings.charge.chargeTargetHint">charge.chargeTargetHint</p></td></tr>
          <tr id ="chargeMinRow">
            <td class="settings_row_name"><label for="chargeMin" data-i18n="settings.charge.chargeMin">charge.chargeMin</label>:</td>
            <td class="settings_row_input"><input id="chargeMin" class="inputElem" type="number" min="1500" max="2000" step="100" value="2000"
              onchange="limitElement(this); updateAdvancedSettings(); displaySaveHint()"> W
              <div class="hintButton" onclick="toggle(this,'chargeMinHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="chargeMinHint" class="hint"><td colspan="2"><p data-i18n="settings.charge.chargeMinHint">charge.chargeMinHint</p></td></tr>
          <tr>
            <td class="settings_row_name"><label for="chargeThreshold" data-i18n="settings.charge.chargeThreshold">charge.chargeThreshold</label>:</td>
            <td class="settings_row_input"><input id="chargeThreshold" class="inputElem" type="number" min="1500" max="20000" step="100" value="2000"
              onchange="limitElement(this); updateAdvancedSettings(); displaySaveHint()"> W
              <div class="hintButton" onclick="toggle(this,'chargeThresholdHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="chargeThresholdHint" class="hint"><td colspan="2"><p data-i18n="settings.charge.chargeThresholdHint">charge.chargeThresholdHint</p></td></tr>
          <tr>
            <td class="settings_row_name"><label for="minToggleTime" data-i18n="settings.charge.minToggleTime">charge.minToggleTime</label>:</td>
            <td class="settings_row_input"><input id="minToggleTime" class="inputElem" type="number" min="90" max="300" step="1" value="120"
              onchange="limitElement(this); displaySaveHint()"> s
              <div class="hintButton" onclick="toggle(this,'minToggleTimeHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="minToggleTimeHint" class="hint"><td colspan="2"><p data-i18n="settings.charge.minToggleTimeHint">charge.minToggleTimeHint</p></td></tr>
          <tr>
            <td class="settings_row_name"><label for="chargeRemaining" data-i18n="settings.charge.chargeRemaining">charge.chargeRemaining</label>:</td>
            <td class="settings_row_input"><input disabled id="chargeRemaining" class="inputElem" type="number" min="0" max="100" step="1" value="0" onchange="displaySaveHint()">
              <span id="chargeRemainingUnit_kWh" data-i18n="units.kWh">kWh</span>
              <span id="chargeRemainingUnit_h" data-i18n="units.hours">h</span>
              <div class="hintButton" onclick="toggle(this,'chargeRemainingHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="chargeRemainingHint" class="hint"><td colspan="2"><p data-i18n="settings.charge.chargeRemainingHint">charge.chargeRemainingHint</p></td></tr>
          <tr>
            <td class="settings_row_name"><label for="chargeEnd" data-i18n="settings.charge.chargeEnd">charge.chargeEnd</label>:</td>
            <td class="settings_row_input"><input disabled id="chargeEnd" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}" type="datetime-local" value="2022-10-13T20:00" onchange="displaySaveHint()">
              <div class="hintButton" onclick="toggle(this,'chargeEndHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="chargeEndHint" class="hint"><td colspan="2"><p data-i18n="settings.charge.chargeEndHint">charge.chargeEndHint</p></td></tr>
        </table>

        <div id ="overrides">
          <input id="collapsibleOverride" class="toggle" type="checkbox">
          <label for="collapsibleOverride" class="lbl-toggle" data-i18n="settings.charge.override" style="color: whitesmoke;">charge.override</label>
          <div class="collapsible-content">
            <div class="content-inner">
              <p data-i18n="settings.charge.overrideHint">charge.overrideHint</p>
              <table class="settings_table">
                <tr>
                  <td class="settings_row_name"><label for="overrideEnable" data-i18n="settings.charge.overrideEnable">charge.overrideEnable</label>:</td>
                  <td class="settings_row_input">
                    <select id="overrideEnable" class="inputElem" onchange="displaySaveHint()">
                      <option value="0" data-i18n="settings.charge.overrideEnableNo">Disabled</option>
                      <option value="1" data-i18n="settings.charge.overrideEnableYes">Enabled</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td class="settings_row_name"><label for="overrideStart" data-i18n="settings.charge.overrideStart">charge.overrideStart</label>:</td>
                  <td class="settings_row_input"><input id="overrideStart" class="inputElem" type="number" min="0" max="40" value="0" onchange="limitElement(this);displaySaveHint()"> A
                    <div class="hintButton" onclick="toggle(this,'overrideHintStart', 'table-row');return false;">i</div>
                  </td>
                </tr>
                <tr id="overrideHintStart" class="hint"><td colspan="2"><p data-i18n="settings.charge.overrideHintStart">charge.overrideHintStart</p></td></tr>
                <tr>
                  <td class="settings_row_name"><label for="overrideStop" data-i18n="settings.charge.overrideStop">charge.overrideStop</label>:</td>
                  <td class="settings_row_input"><input id="overrideStop" class="inputElem" type="number" min="0" max="40" value="0" onchange="limitElement(this);displaySaveHint()"> A
                    <div class="hintButton" onclick="toggle(this,'overrideHintStop', 'table-row');return false;">i</div>
                  </td>
                </tr>
                <tr id="overrideHintStop" class="hint"><td colspan="2"><p data-i18n="settings.charge.overrideHintStop">charge.overrideHintStop</p></td></tr>
                <tr>
                  <td class="settings_row_name"><label for="overridePause" data-i18n="settings.charge.overridePause">charge.overridePause</label>:</td>
                  <td class="settings_row_input"><input id="overridePause" class="inputElem" type="number" min="0" max="40" value="4" onchange="limitElement(this);displaySaveHint()"> A
                    <div class="hintButton" onclick="toggle(this,'overrideHintPause', 'table-row');return false;">i</div>
                  </td>
                </tr>
                <tr id="overrideHintPause" class="hint"><td colspan="2"><p data-i18n="settings.charge.overrideHintPause">charge.overrideHintPause</p></td></tr>
                <tr>
                  <td class="settings_row_name"><label for="overrideMinCurrent" data-i18n="settings.charge.overrideMinCurrent">charge.overrideMinCurrent</label>:</td>
                  <td class="settings_row_input"><input id="overrideMinCurrent" class="inputElem" type="number" min="0" max="40" value="7" onchange="limitElement(this);displaySaveHint()"> A
                    <div class="hintButton" onclick="toggle(this,'overrideHintMin', 'table-row');return false;">i</div>
                  </td>
                </tr>
                <tr id="overrideHintMin" class="hint"><td colspan="2"><p data-i18n="settings.charge.overrideHintMin">charge.overrideHintMin</p></td></tr>
                <tr>
                  <td class="settings_row_name"><label for="overrideMaxCurrent" data-i18n="settings.charge.overrideMaxCurrent">charge.overrideMaxCurrent</label>:</td>
                  <td class="settings_row_input"><input id="overrideMaxCurrent" class="inputElem" type="number" min="0" max="40" value="40" onchange="limitElement(this);displaySaveHint()"> A
                    <div class="hintButton" onclick="toggle(this,'overrideHintMax', 'table-row');return false;">i</div>
                  </td>
                </tr>
                <tr id="overrideHintMax" class="hint"><td colspan="2"><p data-i18n="settings.charge.overrideHintMax">charge.overrideHintMax</p></td></tr>
              </table>
            </div>
          </div>
        </div>
      </fieldset>

      <canvas id="chargeSheduleChart" style="max-height:250px;min-height:250px;display:none"></canvas>
    </div>

    <!-- Global page -->
    <div id="devicePage" class="tabcontent">
      <fieldset>
        <legend for="highPriDevices"><div class="blockHeader" data-i18n="settings.global.controllableDevices">global.controllableDevices</div> 
          <div class="hintButton" onclick="toggle(this,'hintcd1');toggle(this,'hintcd2');return false;">i</div></legend>
        <p id="hintcd1" class="hint" data-i18n="settings.global.deviceListHint1">global.deviceListHint1</p>
        <p id="hintcd2" class="hint" data-i18n="settings.global.deviceListHint2">global.deviceListHint2</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="controlTemp" data-i18n="settings.global.controlTemp">global.controlTemp</label>:</td>
            <td class="settings_row_input">
              <select id="controlTemp">
                <option value=0 data-i18n="settings.global.controlTempNo">global.controlTempNo</option>
                <option value=1 data-i18n="settings.global.controlTempYes">global.controlTempYes</option>
                <option value=2 data-i18n="settings.global.controlTempPreferred" selected>global.controlTempPreferred</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'controlTempHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="controlTempHint" class="hint"><td colspan="2"><p data-i18n="settings.global.controlTempHint">global.controlTempHint</p></td></tr>
          <tr>
            <td class="settings_row_name"><label for="ACMode" data-i18n="settings.ACMode.header">ACMode.header</label>:</td>
            <td class="settings_row_input">
              <select id="ACMode" onchange="displaySaveHint()">
                <option value="0" data-i18n="settings.ACMode.fromAC">Unchanged</option>
                <option value="1" data-i18n="settings.ACMode.auto">Auto</option>
                <option value="2" data-i18n="settings.ACMode.heat">Heating</option>
                <option value="3" data-i18n="settings.ACMode.cool">Cooling</option>
                <option value="4" data-i18n="settings.ACMode.dry">Dry</option>
                <option value="5" data-i18n="settings.ACMode.fan">Fan</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'ACModeHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="ACModeHint" class="hint"><td colspan="2"><p data-i18n="settings.ACMode.hint">ACMode.hint</p></td></tr>
        </table>

        <span id="highPriDevices">High Priority devices should be listed here, if not it is a bug</span>
        <legend for="lowPriDevices"><hr></legend>
        <span id="lowPriDevices">Low Priority devices should be listed here, if not it is a bug</span>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label data-i18n="settings.global.missing">global.missing</label>:</td>
            <td class="settings_row_input">
              <a href="#ShowLog" data-i18n="settings.global.problemsolver" onclick="changeTab(event, 'helpNotFoundPage');return false;">global.problemsolver</a>
            </td>
          </tr>
        </table>
      </fieldset>
    </div>
    <!-- Global page end -->
    
    <!-- Log page -->
    <div id="logPage" class="tabcontent">This page should not be missing. If you see this text please report it as an error</div>

    <!-- Time schedule -->
    <script type="text/javascript">
      function onIframeLoad(iframe) {
        console.log(`Iframe was loaded: ${iframe.src}`);
      }
    </script>
    <div id="schedulePage" class="tabcontent iframe-holder">
      <iframe id="schedulePageInner" src="subpages/schedule.html" onload="onIframeLoad(this);" referrerpolicy="same-origin"></iframe>
      <!--  frameborder="2" marginheight="2" marginwidth="0px" -->
    </div>

    <!-- Price page -->
    <div id="pricePage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.price.header">price.header</legend>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="priceMode" data-i18n="settings.price.priceMode">price.priceMode</label>:</td>
            <td class="settings_row_input">
              <select id="priceMode" onchange="checkPriceMode(this);displaySaveHint()">
                <option value="0" data-i18n="settings.price.mode.flow">From flows</option>
                <option value="1" data-i18n="settings.price.mode.internal">Automatic</option>
                <option value="2" data-i18n="settings.price.mode.disabled" selected>Disabled</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'hintp1');return false;">i</div>
            </td>
          </tr>
        </table>
        <p id="hintp1" class="hint" data-i18n="settings.price.priceHint1">price.priceHint1</p>

        <span id="priceUpperPart" style="display: none">
          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="pricePoint" data-i18n="settings.price.pricePoint">price.pricePoint</label>:</td>
              <td class="settings_row_input">
                <select id="pricePoint" onchange="displaySaveHint()">
                  <option value="0" selected>Price point disabled</option>
                </select>
                <div class="hintButton" onclick="toggle(this,'hintpp');return false;">i</div>
              </td>
            </tr>
          </table>
          <p id="hintpp" class="hint" data-i18n="settings.price.pricePointHint">price.pricePointHint</p>
        </span>

        <span id="priceControl" style="display: none">
        <span id="priceInterpretPart" style="display: none">
          <input id="collapsible1" class="toggle" type="checkbox">
          <label for="collapsible1" class="lbl-toggle" data-i18n="settings.price.pricePointAdvanced" style="color: whitesmoke;">price.pricePointAdvanced</label>
          <div class="collapsible-content">
            <div class="content-inner">
              <table class="settings_table">
                <tr>
                  <td class="settings_row_name"><label for="minCheapTime" data-i18n="settings.price.internal.minCheapTime">price.internal.minCheapTime</label>:</td>
                  <td class="settings_row_input">
                    <input id="minCheapTime" class="inputElem" type="number" size="10" min="0" max="10" step="1" value="4" onchange="limitElement(this);displaySaveHint()">
                    <div class="hintButton" onclick="toggle(this,'minCheapTimeHint');return false;">i</div>
                  </td>
                </tr>
              </table>
              <p id="minCheapTimeHint" class="hint" data-i18n="settings.price.internal.minCheapTimeHint">price.internal.minCheapTimeHint</p>

              <table class="settings_table">
                <tr>
                  <td class="settings_row_name"><label for="minExpensiveTime" data-i18n="settings.price.internal.minExpensiveTime">price.internal.minExpensiveTime</label>:</td>
                  <td class="settings_row_input">
                    <input id="minExpensiveTime" class="inputElem" type="number" size="10" min="0" max="10" step="1" value="4" onchange="limitElement(this);displaySaveHint()">
                    <div class="hintButton" onclick="toggle(this,'minExpensiveTimeHint');return false;">i</div>
                  </td>
                </tr>
              </table>
              <p id="minExpensiveTimeHint" class="hint" data-i18n="settings.price.internal.minExpensiveTimeHint">price.internal.minExpensiveTimeHint</p>

              <table class="settings_table">
                <tr>
                  <td colspan="2">
                    <label data-i18n="settings.price.internal.averageTime">price.internal.averageTime</label>
                    <div class="hintButton" onclick="toggle(this,'averageTimeHint');return false;">i</div>
                  </td>
                </tr>
                <tr>
                  <td class="settings_row_name" valign="top"><label style="margin-left: 20px" for="averageTimePast" data-i18n="settings.price.internal.prev">internal.prev</label>:</td>
                  <td class="settings_row_input">
                    <input id="averageTimePast" class="inputElem" type="number" size="10" min="0" max="1000" step="1" value="4" onchange="limitElement(this);displaySaveHint()">
                    <span data-i18n="settings.price.internal.hours">internal.hours</span>
                  </td>
                </tr>
                <tr>
                  <td class="settings_row_name" valign="top"><label style="margin-left: 20px" for="averageTimeFuture" data-i18n="settings.price.internal.next">internal.next</label>:</td>
                  <td class="settings_row_input">
                    <input id="averageTimeFuture" class="inputElem" type="number" size="10" min="0" max="12" step="1" value="4" onchange="limitElement(this);displaySaveHint()">
                    <span data-i18n="settings.price.internal.hours">internal.hours</span>
                  </td>
                </tr>
              </table>
              <p id="averageTimeHint" class="hint" data-i18n="settings.price.internal.averageTimeHint">price.internal.averageTimeHint</p>

              <table class="settings_table">
                <tr>
                  <td class="settings_row_name"><label for="dirtCheapPriceModifier" data-i18n="settings.price.internal.dirtCheapPriceModifier">price.internal.dirtCheapPriceModifier</label>:</td>
                  <td class="settings_row_input">
                    <input id="dirtCheapPriceModifier" class="inputElem" type="number" size="10" min="-100" max="0" value="-40" onchange="this.max=document.getElementById('lowPriceModifier').value;limitElement(this);displaySaveHint()">%
                    <div class="hintButton" onclick="toggle(this,'dirtCheapPriceModifierHint');return false;">i</div>
                  </td>
                </tr>
              </table>
              <p id="dirtCheapPriceModifierHint" class="hint" data-i18n="settings.price.internal.dirtCheapPriceModifierHint">price.internal.dirtCheapPriceModifierHint</p>

              <table class="settings_table">
                <tr>
                  <td class="settings_row_name"><label for="lowPriceModifier" data-i18n="settings.price.internal.lowPriceModifier">price.internal.lowPriceModifier</label>:</td>
                  <td class="settings_row_input">
                    <input id="lowPriceModifier" class="inputElem" type="number" size="10" min="-50" max="0" value="-15" onchange="this.min=document.getElementById('dirtCheapPriceModifier').value;limitElement(this);displaySaveHint()">%
                    <div class="hintButton" onclick="toggle(this,'lowPriceModifierHint');return false;">i</div>
                  </td>
                </tr>
              </table>
              <p id="lowPriceModifierHint" class="hint" data-i18n="settings.price.internal.lowPriceModifierHint">price.internal.lowPriceModifierHint</p>

              <table class="settings_table">
                <tr>
                  <td class="settings_row_name"><label for="highPriceModifier" data-i18n="settings.price.internal.highPriceModifier">price.internal.highPriceModifier</label>:</td>
                  <td class="settings_row_input">
                    <input id="highPriceModifier" class="inputElem" type="number" size="10" min="0" max="100" value="25" onchange="this.max=document.getElementById('extremePriceModifier').value;limitElement(this);displaySaveHint()">%
                    <div class="hintButton" onclick="toggle(this,'highPriceModifierHint');return false;">i</div>
                  </td>
                </tr>
              </table>
              <p id="highPriceModifierHint" class="hint" data-i18n="settings.price.internal.highPriceModifierHint">price.internal.highPriceModifierHint</p>

              <table class="settings_table">
                <tr>
                  <td class="settings_row_name"><label for="extremePriceModifier" data-i18n="settings.price.internal.extremePriceModifier">price.internal.extremePriceModifier</label>:</td>
                  <td class="settings_row_input">
                    <input id="extremePriceModifier" class="inputElem" type="number" size="10" min="0" max="1000" value="70" onchange="this.min=document.getElementById('highPriceModifier').value;limitElement(this);displaySaveHint()">%
                    <div class="hintButton" onclick="toggle(this,'extremePriceModifierHint');return false;">i</div>
                  </td>
                </tr>
              </table>
              <p id="extremePriceModifierHint" class="hint" data-i18n="settings.price.internal.extremePriceModifierHint">price.internal.extremePriceModifierHint</p>
            </div>
          </div>
        </span>
        </span>
      </fieldset>

      <div id="priceLowerPart">
        <table width="100%" class="tab">
          <tr>
            <td class="subtablinks" onclick="changePriceTab(event, PP_DIRTCHEAP)" id="subtablink4">
              <span data-i18n="settings.pricetab.dirtcheap">pricetab.dirtcheap</span>
            </td>
            <td class="subtablinks" onclick="changePriceTab(event, PP_LOW)" id="subtablink0">
              <span data-i18n="settings.pricetab.cheap">pricetab.cheap</span>
            </td>
            <td class="subtablinks" onclick="changePriceTab(event, PP_NORM)" id="subtablink1">
              <span data-i18n="settings.pricetab.normal">pricetab.normal</span>
            </td>
            <td class="subtablinks" onclick="changePriceTab(event, PP_HIGH)" id="subtablink2">
              <span data-i18n="settings.pricetab.expensive">pricetab.expensive</span>
            </td>
            <td class="subtablinks" onclick="changePriceTab(event, PP_EXTREME)" id="subtablink3">
              <span data-i18n="settings.pricetab.extreme">pricetab.extreme</span>
            </td>
          </tr>
          <tr style="background-color:#a0d0d6;">
            <td colspan="5"><div id="priceActionList">List of devices should have been generated here, if you see this text it is a bug...</div></td>
          </tr>
        </table>
      </div>
    </div>
    <!-- Price page end -->

    <!-- Frost page -->
    <div id="frostPage" class="tabcontent">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.frost.header">frost.header</div> 
          <div class="hintButton" onclick="toggle(this,'frostHint');return false;">i</div>
        </legend>
        <p id="frostHint" class="hint" data-i18n="settings.frost.frostHint">frost.frostHint</p>
        <span id="frostList">List of devices should have been generated here, if you see this text it is a bug...</span>
      </fieldset>
    </div>
    <!-- Frost page end -->

    <!-- Override page -->
    <div id="overridePage" class="tabcontent">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.override.header">override.header</div> 
          <div class="hintButton" onclick="toggle(this,'overrideHint');return false;">i</div>
        </legend>
        <p id="overrideHint" class="hint" data-i18n="settings.override.overrideHint">override.overrideHint</p>
        <span data-i18n="settings.override.overridden">override.overridden</span>:
        <span id="overrideList">Devices should have been filled in here, if you see this text it is a bug</span>
      </fieldset>
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.zone.header">zone.header</div> 
          <div class="hintButton" onclick="toggle(this,'zoneHint');toggle(this,'zoneHint2');return false;">i</div>
        </legend>
        <p id="zoneHint" class="hint" data-i18n="settings.zone.zoneHint">zone.zoneHint</p>
        <p id="zoneHint2" class="hint" data-i18n="settings.zone.zoneHint2">zone.zoneHint</p>
        <span data-i18n="settings.zone.zonesOff">zone.zonesOff</span>:
        <span id="zoneList">Zones should have been filled in here, if you see this text it is a bug</span>
        <button id="clear" class="right" data-i18n="settings.zone.zonesClear" onclick="clearZones();displaySaveHint();return false;">zone.zonesClear</button>
      </fieldset>
    </div>
    <!-- Override page end -->

    <!-- Backup page -->
    <div id="backupPage" class="tabcontent">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.backup.header">backup.header</div></legend>
        <span data-i18n="settings.backup.text">The backup / restore is currently only for debug. You can get the state but not set it.</span>:
      </fieldset>
      <textarea id="backupBlob" cols="50" rows="10"></textarea><br>
      <button id="getState" data-i18n="settings.backup.getState">Get State</button><br>
    </div>
    <!-- Backup page end -->


    <!-- Mode specific page -->
    <div id="priorityPage" class="tabcontent">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.mode.operatingMode">mode.operatingMode</div></legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="operatingMode" data-i18n="settings.mode.activeMode">mode.activeMode</label>:</td>
            <td class="settings_row_input">
              <select id="operatingMode" onchange="displaySaveHint()">
                <option value="1" data-i18n="settings.opMode.normal">Normal</option>
                <option value="2" data-i18n="settings.opMode.night">Night</option>
                <option value="3" data-i18n="settings.opMode.holiday">Holiday</option>
                <option value="4" data-i18n="settings.opMode.custom">Custom</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'operatingModeHint', 'table-row');return false;">i</div>
            </td>
          </tr>
          <tr id="operatingModeHint" class="hint"><td colspan="2"><p data-i18n="settings.mode.operatingModeHint">mode.operatingModeHint</p></td></tr>
        </table>
      </fieldset>

      <table width="100%" id="modeSelector" class="tab">
        <tr>
          <td id="tablink0" class="tablinks" onclick="changeTab(event, 'priorityPage', 0);displaySaveHint();" id="normalTab">
            <span data-i18n="settings.opMode.normal">tab.normal</span>
          </td>
          <td id="tablink1" class="tablinks" onclick="changeTab(event, 'priorityPage', 1);displaySaveHint();" id="nightTab">
            <span data-i18n="settings.opMode.night">tab.night</span>
          </td>
          <td id="tablink2" class="tablinks" onclick="changeTab(event, 'priorityPage', 2);displaySaveHint();" id="holidayTab">
            <span data-i18n="settings.opMode.holiday">tab.holiday</span>
          </td>
          <td id="tablink3" class="tablinks" onclick="changeTab(event, 'priorityPage', 3);displaySaveHint();" id="customTab">
            <span data-i18n="settings.opMode.custom">tab.custom</span>
          </td>
        </tr>
      </table>
  
      <div style="background-color:#a0d0d6;">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.mode.priorities">mode.priorities</div> 
          <div class="hintButton" onclick="toggle(this,'hint6');toggle(this,'hint7');toggle(this,'hint8');return false;">i</div>
          <div id="modeTrashCan" class="icon-trash" style="float:right;display:none" onClick="changeTab(event, 'priorityPage', -1);displaySaveHint();">
            <div class="trash-lid" style="background-color: #e44"></div>
            <div class="trash-container" style="background-color: #e44"></div>
            <div class="trash-line-1"></div>
            <div class="trash-line-2"></div>
            <div class="trash-line-3"></div>
          </div>
        </legend>
        <p id="hint6" class="hint" data-i18n="settings.mode.priorityHint1">mode.priorityHint1</p>
        <p id="hint7" class="hint" data-i18n="settings.mode.priorityHint2">mode.priorityHint2</p>
        <p id="hint8" class="hint" data-i18n="settings.mode.priorityHint3">mode.priorityHint3</p>
        <div id="customModeFlags" style="display:none">
          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="customModeName" data-i18n="settings.mode.modeName">mode.modeName</label>:</td>
              <td class="settings_row_input"><input id="customModeName" type="text" onchange="setModeName(this, currentModeTab-3);displaySaveHint()"></td>
            </tr>
          </table>
        </div>
        <span id="priorityList">List of devices should have been generated here, if you see this text it is a bug...</span>
      </fieldset></div>
    </div>
    <!-- Mode specific page end -->

    <div class="right withMargin" style="display:none;" id="saveOuter">
    <button id="save" class="homey-button-primary-full" data-i18n="settings.saveButton">.saveButton</button>
    </div>

    <script type="text/javascript">

      // Load control
      var operatingModeLoaded = false;
      var ACModeLoaded = false;
      var errorMarginLoaded = false;
      var controlTempLoaded = false;
      var freeThresholdLoaded = false;
      var expireDailyLoaded = false;
      var expireHourlyLoaded = false;
      var safetyPowerLoaded = false;
      var crossSlotSmoothLoaded = false;
      var maxAlarmRateLoaded = false;
      var maxPowerLoaded = false;
      var deviceListLoaded = false;
      var modeListLoaded = false;
      var modeNamesLoaded = false;
      var priceModeLoaded = false;
      var pricePointLoaded = false;
      var priceActionListLoaded = false;
      var frostListLoaded = false;
      var zoneListLoaded = false;
      var overrideListLoaded = false;
      var mainFuseLoaded = false;
      var meterReaderLoaded = false;
      var meterFrequencyLoaded = false;
      var toggleTimeLoaded = false;
      var graphLoaded = false;
      var futurePriceOptionsLoaded = false;
      var chargerOptionsLoaded = false;
      var appConfigProgressLoaded = false;
      var currenciesLoaded = false;
      var onHomeyReadyCompleted = false;

      function updateCarSheduleGraph(chargeShedule, elPrices, currentHour) {
        // Generate data
        let dataHours = Array.from(Array(24).keys()).map((x)=>`${(x+currentHour)%24}:00`);
        let dataPrices = Array.from(Array(24).keys()).map((x)=>elPrices[x+currentHour] || 0);
        let maxPrice = dataPrices.reduce((a,b) => { return !a ? b : !b ? a : a > b ? a : b }) || 1;
        let dataPlan = Array.from(Array(24).keys()).map((x)=>chargeShedule[x] ? maxPrice : 0 );
        let colorBars = Array(24).fill(`skyblue`);
        let colorBarLines = Array(24).fill('black');

        new Chart("chargeSheduleChart", {
          data: {
            labels: dataHours,
            datasets: [{
              type: 'line',
              label: chargePlanGraphPrice,
              borderColor: "black",
              pointBackgroundColor: "black",
              data: dataPrices,
              borderWidth: 1,
              pointRadius: 0,
            }, {
              type: "bar",
              label: 'Charge',
              backgroundColor: colorBars,
              borderColor: colorBarLines,
              borderWidth: 1,
              data: dataPlan
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                title: {
                  display: true,
                  text: chargePlanGraphYAxis
                }
              }
            },
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return `${dataHours[context[0].dataIndex]}`;
                  },
                  beforeFooter: function(context) {
                    if (dataPrices[context[0].dataIndex] === 0) return chargePlanGraphNoPrice;
                    if (dataPlan[context[0].dataIndex]) return chargePlanGraphCharge;
                    return chargePlanGraphNoCharge;
                  }
                },
                filter: function(context) {
                  if (context.dataset.label.startsWith('Charge')) return false;
                  return true;
                }
              },
              legend: {
                display: false,
                position: 'right',
                labels: {
                  boxWidth: 10,
                  font: {
                    size: 9
                  }
                }
              },
              title: {
                display: true,
                text: chargePlanGraphTitle,
                font: {
                  size: 15
                }
              }
            }
          }
        });
        document.getElementById("chargeSheduleChart").style.display='block';
      }

      // Called whenever things has been loaded
      function checkLoadingDone() {
        var loadElement = document.getElementById("loadingPage");
        /* loadElement.innerHTML =
          `maxPowerLoaded: ${maxPowerLoaded}<br>` +
          `deviceListLoaded: ${deviceListLoaded}<br>` +
          `modeListLoaded: ${modeListLoaded}<br>` +
          `modeNamesLoaded: ${modeNamesLoaded}<br>` +
          `operatingModeLoaded: ${operatingModeLoaded}<br>` +
          `ACModeLoaded: ${ACModeLoaded}<br>` +
          `errorMarginLoaded: ${errorMarginLoaded}<br>` +
          `controlTempLoaded: ${controlTempLoaded}<br>` +
          `freeThresholdLoaded: ${freeThresholdLoaded}<br>` +
          `expireDailyLoaded: ${expireDailyLoaded}<br>` +
          `expireHourlyLoaded: ${expireHourlyLoaded}<br>` +
          `safetyPowerLoaded: ${safetyPowerLoaded}<br>` +
          `crossSlotSmoothLoaded: ${crossSlotSmoothLoaded}<br>` +
          `maxAlarmRateLoaded: ${maxAlarmRateLoaded}<br>` +
          `priceModeLoaded: ${priceModeLoaded}<br>` +
          `pricePointLoaded: ${pricePointLoaded}<br>` +
          `priceActionListLoaded: ${priceActionListLoaded}<br>` +
          `frostListLoaded: ${frostListLoaded}<br>` +
          `zoneListLoaded: ${zoneListLoaded}<br>` +
          `overrideListLoaded: ${overrideListLoaded}<br>` +
          `mainFuseLoaded: ${mainFuseLoaded}<br>` +
          `meterReaderLoaded: ${meterReaderLoaded}<br>` +
          `meterFrequencyLoaded: ${meterFrequencyLoaded}<br>` +
          `toggleTimeLoaded: ${toggleTimeLoaded}<br>` +
          `graphLoaded: ${graphLoaded}<br>` +
          `futurePriceOptionsLoaded: ${futurePriceOptionsLoaded}<br>` +
          `chargerOptionsLoaded: ${chargerOptionsLoaded}<br>` +
          `appConfigProgressLoaded: ${appConfigProgressLoaded}<br>` +
          `currenciesLoaded: ${currenciesLoaded}<br>` +
          `onHomeyReadyCompleted: ${onHomeyReadyCompleted}<br>`; */
        if (maxPowerLoaded
          && deviceListLoaded
          && modeListLoaded
          && modeNamesLoaded
          && operatingModeLoaded
          && ACModeLoaded
          && errorMarginLoaded
          && controlTempLoaded
          && freeThresholdLoaded
          && expireDailyLoaded
          && expireHourlyLoaded
          && safetyPowerLoaded
          && crossSlotSmoothLoaded
          && maxAlarmRateLoaded
          && priceModeLoaded
          && pricePointLoaded
          && priceActionListLoaded
          && frostListLoaded
          && zoneListLoaded
          && overrideListLoaded
          && mainFuseLoaded
          && meterReaderLoaded
          && meterFrequencyLoaded
          && toggleTimeLoaded
          && graphLoaded
          && futurePriceOptionsLoaded
          && chargerOptionsLoaded
          && appConfigProgressLoaded
          && currenciesLoaded
          && onHomeyReadyCompleted) {
          // Update device enable list:
          generateEnableList('highPriDevices', 1);
          generateEnableList('lowPriDevices', 0);
          generateReliabilityList();

          // Update max powers
          document.getElementById("maxPower15min").value = Math.min(loadedMaxPower[TIMESPAN.QUARTER], 25000);
          setMaxPowerHour(loadedMaxPower[TIMESPAN.HOUR], 0, 100000);
          document.getElementById("maxPowerDay").value = Math.min(loadedMaxPower[TIMESPAN.DAY] / 1000, 1000);
          document.getElementById("maxPowerMonth").value = Math.min(loadedMaxPower[TIMESPAN.MONTH] / 1000, 50000);
          document.getElementById('enLimit15').checked = loadedMaxPower[TIMESPAN.QUARTER] !== Infinity;
          document.getElementById('enLimit60').checked = loadedMaxPower[TIMESPAN.HOUR] !== Infinity;
          document.getElementById('enLimitDay').checked = loadedMaxPower[TIMESPAN.DAY] !== Infinity;
          document.getElementById('enLimitMonth').checked = loadedMaxPower[TIMESPAN.MONTH] !== Infinity;

          // Initialize state and show the welcome page:
          updateOperatingModes(currentOperatingMode);
          updatePricePoints(currentPricePoint);
          updateCostSchemas();
          updateCountries(futurePriceOptions.priceCountry, futurePriceOptions.costSchema);
          updateRegions(futurePriceOptions.priceCountry, futurePriceOptions.priceRegion);
          loadElement.style.display = "none";
          document.getElementById("main_menu").style.display = "table";
          document.getElementById("saveOuter").style.display = "inline-block";
          document.getElementById("errorMargin").value = currentErrorMargin;
          document.getElementById("freeThreshold").value = currentfreeThreshold;
          document.getElementById("safetyPower").value = currentSafetyPower;
          document.getElementById("pricePoint").value = currentPricePoint;
          document.getElementById("mainFuse").value = currentMainFuse;
          document.getElementById("costSchema").value = futurePriceOptions.costSchema;
          document.getElementById("peakStart").value = minToTime(futurePriceOptions.peakStart);
          document.getElementById("peakEnd").value = minToTime(futurePriceOptions.peakEnd);
          document.getElementById("weekendOffPeak").checked = futurePriceOptions.weekendOffPeak;
          document.getElementById("govSubsidy").checked = futurePriceOptions.govSubsidyEn;
          document.getElementById("govSubsidyThreshold").value = futurePriceOptions.govSubsidyThreshold;
          document.getElementById("govSubsidyRate").value = futurePriceOptions.govSubsidyRate;
          document.getElementById("gridSteps").checked = futurePriceOptions.gridSteps;
          document.getElementById("granularity").value = futurePriceOptions.granularity;
          document.getElementById("peakMin").value = futurePriceOptions.peakMin;
          document.getElementById("peakTax").value = futurePriceOptions.peakTax;
          document.getElementById("averageTimePast").value = futurePriceOptions.averageTimePast;
          document.getElementById("averageTimeFuture").value = futurePriceOptions.averageTimeFuture;
          document.getElementById("minCheapTime").value = futurePriceOptions.minCheapTime;
          document.getElementById("minExpensiveTime").value = futurePriceOptions.minExpensiveTime;
          document.getElementById("dirtCheapPriceModifier").value = futurePriceOptions.dirtCheapPriceModifier;
          document.getElementById("lowPriceModifier").value = futurePriceOptions.lowPriceModifier;
          document.getElementById("highPriceModifier").value = futurePriceOptions.highPriceModifier;
          document.getElementById("extremePriceModifier").value = futurePriceOptions.extremePriceModifier;
          document.getElementById("priceKind").value = futurePriceOptions.priceKind;
          document.getElementById("surcharge").value = futurePriceOptions.surcharge;
          document.getElementById("priceFixed").value = futurePriceOptions.priceFixed;
          document.getElementById("gridTaxDay").value = futurePriceOptions.gridTaxDay;
          document.getElementById("gridTaxNight").value = futurePriceOptions.gridTaxNight;
          document.getElementById("VAT").value = futurePriceOptions.VAT;
          document.getElementById('currency').value = futurePriceOptions.currency;
          document.getElementById('chargeTarget').value = chargerOptions.chargeTarget;
          document.getElementById('chargeMin').value = chargerOptions.chargeMin;
          document.getElementById('chargeThreshold').value = chargerOptions.chargeThreshold;
          document.getElementById('minToggleTime').value = chargerOptions.minToggleTime;
          document.getElementById('chargeRemaining').value = chargerOptions.chargeRemaining / ((chargerOptions.chargeCycleType === OFFER_HOURS) ? 1 : 1000);
          document.getElementById('chargeRemainingUnit_kWh').style.display = (chargerOptions.chargeCycleType === OFFER_ENERGY) ? 'inline-block' : 'none';
          document.getElementById('chargeRemainingUnit_h').style.display = (chargerOptions.chargeCycleType === OFFER_HOURS) ? 'inline-block' : 'none';
          document.getElementById('chargeEnd').value = toTimeString(new Date(chargerOptions.chargeEnd));
          document.getElementById('overrideEnable').value = +chargerOptions.overrideEnable;
          document.getElementById('overrideStart').value = +chargerOptions.overrideStart;
          document.getElementById('overrideStop').value = +chargerOptions.overrideStop;
          document.getElementById('overridePause').value = +chargerOptions.overridePause;
          document.getElementById('overrideMinCurrent').value = +chargerOptions.overrideMinCurrent;
          document.getElementById('overrideMaxCurrent').value = +chargerOptions.overrideMaxCurrent;
          document.getElementById("energyFlowRateText").innerHTML = energyFlowRateText.replace("${interval}", Math.round(appConfigProgress.timeSinceEnergyMeter / 60));
          document.getElementById("spookeyText").innerHTML = spookeyText.replace("${times}", appConfigProgress.numSpookeyChanges);
          checkPriceMode(document.getElementById("priceMode")); // not called automatically when programatically changed
          checkPriceKind(); // not called automatically when programatically changed
          changeTab(false, 'welcomePage');
        }
      }

      // Filters a popup so the user doesn't get spammed
      let popUpOk = true;
      function popUp(Homey, message) {
        if (popUpOk) {
          try {
            Homey.alert(message);
          } catch(err) {}; // Ignore popup blockers
          popUpOk = false;
          setTimeout(() => { popUpOk = true; }, 1000);
        } else {
          console.log(`Supressed popup: ${message}`);
        }
      }

      // a method to alert the user about something went wrong
      function alertUser(Homey, message) {
        if (String(message).includes('getVersion')
          || String(message).includes('getDevices')
          || String(message).includes('apiCommand')
          || String(message).includes('getStats')) {
          popUp(Homey, 'It seems like Homey is updating the app version. Please try again in a minute or two when the app has been properly installed.');
          console.log('Believed app update detected?');
          console.log(message);
        } else {
          popUp(Homey, message);
        }
      }

      // a method named 'onHomeyReady' must be present in your code
      function onHomeyReady(Homey) {

        // Tell Homey we're ready to be displayed
        Homey.ready();

        var saveElement = document.getElementById("save");
        var appEnabledElement = document.getElementById("appEnabled");
        var operatingModeElement = document.getElementById("operatingMode");
        var errorMarginElement = document.getElementById("errorMargin");
        var controlTempElement = document.getElementById("controlTemp");
        var freeThresholdElement = document.getElementById("freeThreshold");
        var safetyPowerElement = document.getElementById("safetyPower");
        var crossSlotSmoothElement = document.getElementById("crossSlotSmooth");
        var maxAlarmRateElement = document.getElementById("maxAlarmRate");
        var priceModeElement = document.getElementById("priceMode");
        var pricePointElement = document.getElementById("pricePoint");
        var mainFuseElement = document.getElementById("mainFuse");
        var rememberToSaveElement = document.getElementById("rememberToSave");
        var currencyElement = document.getElementById("currency");

        // Fetch translation strings from Homey
        unitsText = Homey.__(unitsText);
        timeScheduleText = Homey.__(timeScheduleText);
        ACModeText = Homey.__(ACModeText);
        thermostatText = Homey.__(thermostatText);
        activeText = Homey.__(activeText);
        noPowText = Homey.__(noPowText);
        deltaText = Homey.__(deltaText);
        actionText = Homey.__(actionText);
        deviceText = Homey.__(deviceText);
        turnOnText = Homey.__(turnOnText);
        turnOffText = Homey.__(turnOffText);
        minTempText = Homey.__(minTempText);
        priorityText = Homey.__(priorityText);
        alwaysOnText = Homey.__(alwaysOnText);
        priceDirtCheapText = Homey.__(priceDirtCheapText);
        priceLowText = Homey.__(priceLowText);
        deltaTempText = Homey.__(deltaTempText);
        emergencyOffText = Homey.__(emergencyOffText);
        ignoreText = Homey.__(ignoreText);
        alwaysOffText = Homey.__(alwaysOffText);
        priceHighText = Homey.__(priceHighText);
        priceExtremeText = Homey.__(priceExtremeText);
        targetTempText = Homey.__(targetTempText);
        controlledText = Homey.__(controlledText);
        priceNormalText = Homey.__(priceNormalText);
        leavePageText = Homey.__(leavePageText);
        zoneNameText = Homey.__(zoneNameText);
        zoneNumText = Homey.__(zoneNumText);
        overrideDeviceText = Homey.__(overrideDeviceText);
        overrideStatusText = Homey.__(overrideStatusText);
        overrideonText = Homey.__(overrideonText);
        overrideoffText = Homey.__(overrideoffText);
        overrideoffUntilOnText = Homey.__(overrideoffUntilOnText);
        overridetempText = Homey.__(overridetempText);
        overridefrostText = Homey.__(overridefrostText);
        overrideControlledText = Homey.__(overrideControlledText);
        overrideZoneText = Homey.__(overrideZoneText);
        helpButtons = Homey.__(helpButtons);
        helpButtonOn = Homey.__(helpButtonOn);
        helpButtonOff = Homey.__(helpButtonOff);
        helpButtonDelta = Homey.__(helpButtonDelta);
        helpButtonEmergency = Homey.__(helpButtonEmergency);
        helpButtonIgnore = Homey.__(helpButtonIgnore);
        timeoutText = Homey.__(timeoutText);
        energyFlowRateText = Homey.__(energyFlowRateText);
        experimentalText = Homey.__(experimentalText);
        spookeyText = Homey.__(spookeyText);
        onGoingText = Homey.__(onGoingText);
        modeNameDayText = Homey.__(modeNameDayText);
        modeNameNightText = Homey.__(modeNameNightText);
        modeNameHolidayText = Homey.__(modeNameHolidayText);
        modeNameCustomText = Homey.__(modeNameCustomText);
        stepText = Homey.__(stepText);
        reliabilityText = Homey.__(reliabilityText);
        reliabilityHelp = Homey.__(reliabilityHelp);
        deviceTypeText[0] = Homey.__(deviceTypeText[0]);
        deviceTypeText[1] = Homey.__(deviceTypeText[1]);
        deviceTypeText[2] = Homey.__(deviceTypeText[2]);
        deviceTypeText[3] = Homey.__(deviceTypeText[3]);
        deviceTypeText[4] = Homey.__(deviceTypeText[4]);
        deviceTypeText[5] = Homey.__(deviceTypeText[5]);
        deviceTypeText[6] = Homey.__(deviceTypeText[6]);
        chargePlanGraphTitle = Homey.__(chargePlanGraphTitle);
        chargePlanGraphYAxis = Homey.__(chargePlanGraphYAxis);
        chargePlanGraphPrice = Homey.__(chargePlanGraphPrice);
        chargePlanGraphCharge = Homey.__(chargePlanGraphCharge);
        chargePlanGraphNoCharge = Homey.__(chargePlanGraphNoCharge);
        chargePlanGraphNoPrice = Homey.__(chargePlanGraphNoPrice);
        withSubsidyText = Homey.__(withSubsidyText);
        withoutSubsidyText = Homey.__(withoutSubsidyText);

        for (var i = 0; i < pricePoints.length; i++) {
          pricePoints[i].name = Homey.__(pricePoints[i].name);
        }

        // Request devicelist refresh
        Homey.api('GET', '/apiCommand?cmd=createDeviceList', null, function (err, response) {
          if (err) {
            alertUser(Homey, `Could not load device list (${err})`);
          } else if (Object.keys(response).length === 0) {
            popUp(Homey, 'No controllable devices found (check help section for instructions)');
          } else {
            deviceList = response;
            deviceListLoaded = true;
            checkLoadingDone();
          }
        });

        // Refresh price data
        Homey.get("futurePriceOptions", function (err, options) {
          if (err) return popUp(Homey, err);
          if (options) {
            futurePriceOptions = options;
          } else {
            futurePriceOptions = {}
          }
          setGridCost(futurePriceOptions.gridCosts);
          futurePriceOptionsLoaded = true;

          // Maxpower cannot be updated before after setGridCost has been called
          Homey.get("maxPower", function (err, maxPower) {
            if (err) return popUp(Homey, err);
            if (maxPower === null || !Array.isArray(maxPower)) {
              // use defaults set from the top (this is the first time)
              maxPower = [Infinity, 5000, Infinity, 5000000];
            }
            loadedMaxPower = maxPower.map(val => ((val === null) ? Infinity : val));
            maxPowerLoaded = true;
            checkLoadingDone();
          });

          // Aquire graphs (must be after setGridCost)
          const instantly = new Date().getTime();
          Homey.api('GET', `/getStats?type=[chargePlan,maxPower]&time=${instantly}&granularity=${GRANULARITY.DAY}`, null, function (err, res) {
            if (err) return alertUser(Homey, err);
            try {
              InitGraph(Homey, res, futurePriceOptions.granularity);
              updateCarSheduleGraph(res.data.chargeShedule || [], res.data.elPrices || [], res.data.currentHour);
              noPrices = !Array.isArray(res.data.elPrices) || (res.data.elPrices.length == 0)
            } catch (err2) {
              return alertUser(Homey, err2);
            }
            graphLoaded = true;
            checkLoadingDone();
          });

        });

        // Refresh charger data
        Homey.get("chargerOptions", function (err, options) {
          if (err) return popUp(Homey, err);
          if (options) {
            chargerOptions = options;
          } else {
            chargerOptions = {}
          }
          chargerOptionsLoaded = true;
          checkLoadingDone();
        });

        // Refresh currencies
        Homey.api('GET', '/apiCommand?cmd=getCurrencies', null, function (err, currencies) {
          if (err) return alertUser(Homey, err);
          let newCurrencyText = '';
          for (let currencyId in currencies) {
            newCurrencyText += `<option value="${currencyId}">${currencies[currencyId]} (${currencyId})</option>`;
          }
          currencyElement.innerHTML = newCurrencyText;

          currenciesLoaded = true;
          checkLoadingDone();
        });

        // Refresh meter readers
        Homey.api('GET', '/apiCommand?cmd=getMeterReaders', null, function (err, meterReaders) {
          if (err) return alertUser(Homey, err);
          if (typeof meterReaders !== 'object') return alertUser(Homey, new Error('The app has not initialized correctly, please contact the App developer'));
          let newMeterReaderText = `<option value="0">${Homey.__('settings.meter.useFlow')}</option>`;
          let selectedText = ' selected';
          for (let readerId in meterReaders) {
            const { driverId, canUse } = meterReaders[readerId];
            newMeterReaderText += `<option value="${readerId}"${canUse?selectedText:''}>${meterReaders[readerId].name}</option>`;
            if (canUse) selectedText = '';
          }
          document.getElementById('meterReader').innerHTML = newMeterReaderText;

          if (Object.keys(meterReaders).length == 0) {
            document.getElementById('meterReaderNotFound').style.display = 'block';
          }

          Homey.get("meterReader", function (err, meterReader) {
            if (err) return popUp(Homey, err);
            if (meterReader !== null) document.getElementById('meterReader').value = meterReader;
            meterReaderLoaded = true;
            checkLoadingDone();
          });
        });

        // Refresh API configuration progress
        Homey.api('GET', '/apiCommand?cmd=getAppConfigProgress', null, function (err, options) {
          if (err) return alertUser(Homey, err);
          if (options) {
            appConfigProgress = options;
          } else {
            appConfigProgress = {}
          }
          if (!appConfigProgress.hasOwnProperty("gotPPFromFlow")) appConfigProgress.gotPPFromFlow = false;
          if (!appConfigProgress.hasOwnProperty("timeSinceEnergyMeter")) appConfigProgress.timeSinceEnergyMeter = Infinity;
          if (!appConfigProgress.hasOwnProperty("energyMeterNotConnected")) appConfigProgress.energyMeterNotConnected = true;
          if (!appConfigProgress.hasOwnProperty("ApiStatus")) appConfigProgress.ApiStatus = 0;
          appConfigProgressLoaded = true;
          checkLoadingDone();
        });

        // Get the mode list
        Homey.get("modeList", function (err, myModeList) {
          if (err) return popUp(Homey, err);
          if (Array.isArray(myModeList)) {
            modeList = myModeList;
          } else {
            // First time called
            modeList = [
              [], // Normal
              [], // Night
              []  // Holiday
            ]
          }
          modeListLoaded = true;
          checkLoadingDone();
        })
        // Get the mode names
        Homey.get("modeNames", function (err, myModeNames) {
          if (err) return popUp(Homey, err);
          if (Array.isArray(myModeNames)) {
            modeNames = myModeNames;
          } else {
            // First time called
            modeNames = modeList.slice(3,8).map(x => `Custom mode`);
          }
          modeNamesLoaded = true;
          checkLoadingDone();
        })
        Homey.get("frostList", function (err, myFrostList) {
          if (err) return popUp(Homey, err);
          if (myFrostList !== null) {
            frostList = myFrostList;
          } // else use defaults set from the top (this is the first time)
          frostListLoaded = true;
          checkLoadingDone();
        });
        Homey.get("zones", function (err, myZoneList) {
          if (err) return popUp(Homey, err);
          if (myZoneList !== null) {
            zoneList = myZoneList;
          } // else use defaults set from the top
          zoneListLoaded = true;
          checkLoadingDone();
        })
        Homey.get("override", function (err, myOverrideList) {
          if (err) return popUp(Homey, err);
          if (myOverrideList !== null) {
            overrideList = myOverrideList;
          } // else use defaults set from the top
          overrideListLoaded = true;
          checkLoadingDone();
        })
        Homey.get("priceActionList", function (err, mypriceActionList) {
          if (err) return popUp(Homey, err);
          if (mypriceActionList !== null) {
            priceActionList = mypriceActionList;
          } // else use defaults set from the top (this is the first time)
          priceActionListLoaded = true;
          checkLoadingDone();
        });
        Homey.get("operatingMode", function (err, operatingMode) {
          if (err) return popUp(Homey, err);
          if (operatingMode !== null) {
            currentOperatingMode = +operatingMode;
          } else {
            currentOperatingMode = 0;
          }
          operatingModeLoaded = true;
          checkLoadingDone();
        });
        Homey.get("ACMode", function (err, ACMode) {
          if (err) return popUp(Homey, err);
          if (ACMode !== null) {
            document.getElementById("ACMode").value = +ACMode
          } else {
            document.getElementById("ACMode").value = 0;
          }
          ACModeLoaded = true;
          checkLoadingDone();
        });
        Homey.get("priceMode", function (err, priceMode) {
          if (err) return popUp(Homey, err);
          if (priceMode !== null) {
            document.getElementById("priceMode").value = +priceMode;
          } else {
            document.getElementById("priceMode").value = 2;
          }
          priceModeLoaded = true;
          checkLoadingDone();
        });
        Homey.get("pricePoint", function (err, pricePoint) {
          if (err) return popUp(Homey, err);
          if (pricePoint !== null) {
            currentPricePoint = pricePoint;
          } else {
            currentPricePoint = 1; // Set to normal as default
          }
          pricePointLoaded = true;
          checkLoadingDone();
        });
        Homey.get("errorMargin", function (err, errorMargin) {
          if (err) return popUp(Homey, err);
          if (errorMargin !== null) {
            currentErrorMargin = errorMargin;
          } else {
            currentErrorMargin = 5;
          }
          errorMarginLoaded = true;
          checkLoadingDone();
        });
        Homey.get("controlTemp", function (err, temp) {
          if (err) return popUp(Homey, err);
          if (temp !== null) {
            document.getElementById("controlTemp").value = +temp;
          } else {
            document.getElementById("controlTemp").value = 2;
          }
          controlTempLoaded = true;
          checkLoadingDone();
        });
        Homey.get("freeThreshold", function (err, threshold) {
          if (err) return popUp(Homey, err);
          if (threshold !== null) {
            currentfreeThreshold = threshold;
          } else {
            currentfreeThreshold = 100;
          }
          freeThresholdLoaded = true;
          checkLoadingDone();
        });
        Homey.get("expireDaily", function (err, expiretime) {
          if (err) return popUp(Homey, err);
          document.getElementById("expireDaily").value = expiretime;
          expireDailyLoaded = true;
          checkLoadingDone();
        });
        Homey.get("expireHourly", function (err, expiretime) {
          if (err) return popUp(Homey, err);
          document.getElementById("expireHourly").value = expiretime;
          expireHourlyLoaded = true;
          checkLoadingDone();
        });
        Homey.get("safetyPower", function (err, safetyPower) {
          if (err) return popUp(Homey, err);
          if (safetyPower !== null) {
            currentSafetyPower = safetyPower;
          } else {
            currentSafetyPower = 500;
          }
          safetyPowerLoaded = true;
          checkLoadingDone();
        });
        Homey.get("crossSlotSmooth", function (err, crossSlotSmooth) {
          if (err) return popUp(Homey, err);
          document.getElementById("crossSlotSmooth").value = crossSlotSmooth;
          crossSlotSmoothLoaded = true;
          checkLoadingDone();
        });
        Homey.get("maxAlarmRate", function (err, maxAlarmRate) {
          if (err) return popUp(Homey, err);
          document.getElementById("maxAlarmRate").value = maxAlarmRate;
          document.getElementById('enLimitMissing').checked = +maxAlarmRate !== 0;
          maxAlarmRateLoaded = true;
          checkLoadingDone();
        });
        Homey.get("mainFuse", function (err, mainFuse) {
          if (err) return popUp(Homey, err);
          if (mainFuse !== null) {
            currentMainFuse = mainFuse;
          } else {
            currentMainFuse = 63; // 63 Amps is the most common main fuse in Norway
          }
          mainFuseLoaded = true;
          checkLoadingDone();
        });
        Homey.get("meterFrequency", function (err, meterFrequency) {
          if (err) return popUp(Homey, err);
          document.getElementById('meterFrequency').value = meterFrequency;
          meterFrequencyLoaded = true;
          checkLoadingDone();
        });
        Homey.get("toggleTime", function (err, toggleTime) {
          if (err) return popUp(Homey, err);
          document.getElementById('toggleTime').value = toggleTime;
          toggleTimeLoaded = true;
          checkLoadingDone();
        });
        // TODO: Load from Homey
        schedules = [{
          name: "Weekday - Living Room",
          deltaTemp: 1,
          tempRange: 35,
          items: [{
            start: 0,
            operation: this.DEVICE_OP.CONTROLLED_ON,
            tempOp: this.TEMP_OP.PRICE,
            temp: [5, 12, 13, 15, 17, 18, 27, 28, 29, 30, 31, 35],
            ACMode: 0
          },
          {
            start: 6*60,
            operation: this.DEVICE_OP.CONTROLLED_ON,
            tempOp: this.TEMP_OP.PRICE,
            temp: [5, 17, 18, 20, 22, 23, 25, 26, 27, 28, 29, 35],
            ACMode: 0
          },
          {
            start: 15*60,
            operation: this.DEVICE_OP.CONTROLLED_ON,
            tempOp: this.TEMP_OP.PRICE,
            temp: [5, 21, 22, 24, 26, 27, 27, 28, 29, 30, 31, 35],
            ACMode: 0
          },
          {
            start: 22*60,
            operation: this.DEVICE_OP.CONTROLLED_ON,
            tempOp: this.TEMP_OP.PRICE,
            temp: [5, 12, 13, 15, 17, 18, 27, 28, 29, 30, 31, 35],
            ACMode: 0
          }]
        }];
        // Refresh log data
        initializeLogPage(document, Homey)
        .catch(err => {
          if (err) alertUser(Homey, err)
        });

        // This error function is a bit deciving because it is also called on success, however then with message = 'OK'
        const errFunc = (err) => { 
          if (err) {
            Homey.api('GET', `/apiCommand?cmd=log&text=${err.message}&loglevel=0`, null, function (err2, result) {});
            // An error occured
            alertUser(Homey, err.message);
            saveElement.classList.remove('is-loading');
            document.getElementById("savingOverlay").style.display = 'none';
          }
        }
        const savedFunc = (err) => {
          if (err) {
            Homey.api('GET', `/apiCommand?cmd=log&text=${err.message}&loglevel=0`, null, function (err2, result) {});
            // An error occured
            alertUser(Homey, err.message);
          } else {
            // Settings was saved successfully
            rememberToSaveElement.style.display = 'none';
          }
          saveElement.classList.remove('is-loading');
          document.getElementById("savingOverlay").style.display = 'none';
        }
        document.getElementById("getState").addEventListener("click", e => {
          Homey.api('GET', '/apiCommand?cmd=getFullState', null, function (err, result) {
            if (err) alertUser(Homey, err);
            document.getElementById("backupBlob").value = JSON.stringify(result, (key, value) => {
              return value === Infinity ? 'Infinity' : value;
            }, 2);
          });
        });
        document.getElementById("archiveParam").addEventListener("change", e => updateArchiveParam(Homey, 0));
        document.getElementById("archiveTimespan").addEventListener("change", e => updateArchiveParam(Homey, 1));
        document.getElementById("archiveSlot").addEventListener("change", e => updateArchiveParam(Homey, 2));
        document.getElementById("archiveItem").addEventListener("change", e => updateArchiveParam(Homey, 3));
        document.getElementById("archiveButton").addEventListener("click", e => submitArchiveParam(Homey));

        const saveFunc = () => {
          saveElement.classList.add('is-loading');
          document.getElementById("savingOverlay").style.display = 'block';
          try {
            // Make sure all settings are up to date:
            refreshModeLists(); // It's a pitty but the user did not even visit these pages. Probably they will do later
            refreshFrostList(); // It's a pitty but the user did not even visit these pages. Probably they will do later
            refreshPriceActionList(); // It's a pitty but the user did not even visit these pages. Probably they will do later
            updateChargerHints(deviceList); // In case the user added a charger as controllable then the charger mode is still FLOW and must be updated to AUTO
            updateAdvancedSettings();
            if (Object.keys(frostList).length === 0) {
              try {
                popUp(Homey, Homey.__('warnings.noDevices'));
              } catch(err) {}; // Ignore popup blockers
            } else {
              futurePriceOptions.costSchema = document.getElementById("costSchema").value;
              futurePriceOptions.peakStart = timeToMinSinceMidnight(document.getElementById("peakStart").value);
              futurePriceOptions.peakEnd = timeToMinSinceMidnight(document.getElementById("peakEnd").value);
              futurePriceOptions.weekendOffPeak = document.getElementById("weekendOffPeak").checked;
              futurePriceOptions.govSubsidyEn = document.getElementById("govSubsidy").checked;
              futurePriceOptions.govSubsidyThreshold = +document.getElementById("govSubsidyThreshold").value;
              futurePriceOptions.govSubsidyRate = +document.getElementById("govSubsidyRate").value;
              futurePriceOptions.gridSteps = document.getElementById("gridSteps").checked;
              futurePriceOptions.granularity = +document.getElementById("granularity").value;
              futurePriceOptions.peakMin = +document.getElementById("peakMin").value;
              futurePriceOptions.peakTax = +document.getElementById("peakTax").value;
              futurePriceOptions.averageTimePast = document.getElementById("averageTimePast").value;
              futurePriceOptions.averageTimeFuture = document.getElementById("averageTimeFuture").value;
              futurePriceOptions.minCheapTime = document.getElementById("minCheapTime").value;
              futurePriceOptions.minExpensiveTime = document.getElementById("minExpensiveTime").value;
              futurePriceOptions.dirtCheapPriceModifier = document.getElementById("dirtCheapPriceModifier").value;
              futurePriceOptions.lowPriceModifier = document.getElementById("lowPriceModifier").value;
              futurePriceOptions.highPriceModifier = document.getElementById("highPriceModifier").value;
              futurePriceOptions.extremePriceModifier = document.getElementById("extremePriceModifier").value;
              futurePriceOptions.priceKind = document.getElementById("priceKind").value;
              futurePriceOptions.priceCountry = document.getElementById("priceCountry").value;
              futurePriceOptions.priceRegion = document.getElementById("priceRegion").value;
              futurePriceOptions.surcharge = document.getElementById("surcharge").value;
              futurePriceOptions.priceFixed = document.getElementById("priceFixed").value;
              futurePriceOptions.gridTaxDay = document.getElementById("gridTaxDay").value;
              futurePriceOptions.gridTaxNight = document.getElementById("gridTaxNight").value;
              futurePriceOptions.VAT = document.getElementById("VAT").value;
              futurePriceOptions.currency = document.getElementById('currency').value;
              futurePriceOptions.gridCosts = gridCost;
              chargerOptions.chargeTarget = +document.getElementById('chargeTarget').value;
              chargerOptions.chargeMin = +document.getElementById('chargeMin').value;
              chargerOptions.chargeThreshold = +document.getElementById('chargeThreshold').value;
              chargerOptions.minToggleTime = +document.getElementById('minToggleTime').value;
              // chargerOptions.chargeRemaining = +document.getElementById('chargeRemaining').value; // Ignore as it is read only
              // chargerOptions.chargeEnd = +document.getElementById('chargeEnd').value; // Ignore as it is read only (and converted to localtime)
              chargerOptions.overrideEnable = +document.getElementById('overrideEnable').value;
              chargerOptions.overrideStart = +document.getElementById('overrideStart').value;
              chargerOptions.overrideStop = +document.getElementById('overrideStop').value;
              chargerOptions.overridePause = +document.getElementById('overridePause').value;
              chargerOptions.overrideMinCurrent = +document.getElementById('overrideMinCurrent').value;
              chargerOptions.overrideMaxCurrent = +document.getElementById('overrideMaxCurrent').value;
              if (+operatingModeElement.value > modeList.length) {
                operatingModeElement.value = MODE_NORMAL;
              }
              let opModeValue = (appEnabledElement.value === "1") ? operatingModeElement.value : 0;
              loadedMaxPower[TIMESPAN.QUARTER] = document.getElementById("enLimit15").checked
                ? +document.getElementById("maxPower15min").value : Infinity;
              loadedMaxPower[TIMESPAN.HOUR] = document.getElementById("enLimit60").checked
                ? +document.getElementById("maxPowerHour").value : Infinity;
              loadedMaxPower[TIMESPAN.DAY] = document.getElementById("enLimitDay").checked
                ? +document.getElementById("maxPowerDay").value * 1000 : Infinity;
              loadedMaxPower[TIMESPAN.MONTH] = document.getElementById("enLimitMonth").checked
                ? +document.getElementById("maxPowerMonth").value * 1000 : Infinity;
              Homey.set("futurePriceOptions", futurePriceOptions, errFunc);
              Homey.set('chargerOptions', chargerOptions, errFunc);
              Homey.set("deviceList", deviceList, errFunc);
              Homey.set("modeList", modeList, errFunc);
              Homey.set("modeNames", modeNames, errFunc);
              Homey.set("frostList", frostList, errFunc);
              Homey.set("zones", zoneList, errFunc);
              Homey.set("maxPower", loadedMaxPower, errFunc);
              Homey.set("operatingMode", opModeValue, errFunc);
              Homey.set("ACMode", document.getElementById("ACMode").value, errFunc);
              Homey.set("priceMode", priceModeElement.value, errFunc);
              Homey.set("pricePoint", pricePointElement.value, errFunc);
              Homey.set("priceActionList", priceActionList, errFunc);
              Homey.set("errorMargin", errorMarginElement.value, errFunc);
              Homey.set("controlTemp", controlTempElement.value, errFunc);
              Homey.set("freeThreshold",freeThresholdElement.value, errFunc);
              Homey.set("expireDaily",document.getElementById("expireDaily").value, errFunc);
              Homey.set("expireHourly",document.getElementById("expireHourly").value, errFunc);
              Homey.set("safetyPower", safetyPowerElement.value, errFunc);
              Homey.set("crossSlotSmooth", crossSlotSmoothElement.value, errFunc);
              Homey.set("maxAlarmRate", maxAlarmRateElement.value, errFunc);
              Homey.set("mainFuse", mainFuseElement.value, errFunc);
              Homey.set("meterReader", document.getElementById("meterReader").value, errFunc);
              Homey.set("meterFrequency", document.getElementById("meterFrequency").value, errFunc);
              Homey.set("toggleTime", document.getElementById("toggleTime").value, errFunc);
              Homey.set("settingsSaved", "", errFunc); // On settings is only called if the settings actually changed
              Homey.set("settingsSaved", "true", savedFunc);
            }
          }
          catch (err) {
            saveElement.classList.remove('is-loading');
            document.getElementById("savingOverlay").style.display = 'none';
            popUp(Homey, Homey.__(`warnings.savingFailed: ${err}`));
          }
        }
        saveElement.addEventListener("click", function (e) {
          if ((loadedMaxPower !== null)
            && ((document.getElementById("enLimit15").checked && +document.getElementById("maxPower15min").value > +loadedMaxPower[TIMESPAN.QUARTER])
              || (document.getElementById("enLimit60").checked && +document.getElementById("maxPowerHour").value > +loadedMaxPower[TIMESPAN.HOUR])
              || (document.getElementById("enLimitDay").checked && +document.getElementById("maxPowerDay").value > (+loadedMaxPower[TIMESPAN.DAY]/1000))
              || (document.getElementById("enLimitMonth").checked && +document.getElementById("maxPowerMonth").value > (+loadedMaxPower[TIMESPAN.MONTH]/1000)))) {
            try {
              const before = new Date();
              Homey.confirm(Homey.__('settings.alert.maxPowerChanged'))
                .then((res) => {
                  const called = new Date();
                  const diff = called - before;
                  // NB! Popup blockers will not give an error on the confirm dialogue
                  // If the diff < 0.1 sec then the confirm was likely aborted by a popup blocker
                  if (res || diff < 100) {
                    saveFunc();
                  }
                });
            } catch (err) {
              saveFunc(); // In case of errors, save anyway
            }
          } else {
            saveFunc();
          }
        });

        document.getElementById("maxHourButton").addEventListener("click", e => { onShowMaxHourGraph(Homey) });
        document.getElementById("consumptionButton").addEventListener("click", e => { onShowConsumptionGraph(Homey) });
        document.getElementById("pricesButton").addEventListener("click", e => { onShowPricesGraph(Homey) });
        // document.getElementById("savingsButton").addEventListener("click", e => { onShowSavingsGraph(Homey) });
        document.getElementById("dayButton").addEventListener("click", e => { onShowDayTimespan(Homey) });
        document.getElementById("monthButton").addEventListener("click", e => { onShowMonthTimespan(Homey) });
        document.getElementById("yearButton").addEventListener("click", e => { onShowYearTimespan(Homey) });
        document.getElementById("ltButton").addEventListener("click", e => { onBackClick(Homey) });
        document.getElementById("gtButton").addEventListener("click", e => { onForwardClick(Homey) });

        setTimeout(function () {
          onHomeyReadyCompleted = true;
          checkLoadingDone();
        }, 4 * 1000);

        setTimeout(function () {
          loadElement = document.getElementById("loadingPage");
          if (loadElement.style.display !== "none") {
            loadElement.innerHTML = timeoutText;
          }
        }, 8 * 1000);
      }

      function refreshPriceActionList() {
        for (var tabPage = 0; tabPage < 5; tabPage++) {
          if (priceActionList[tabPage] === undefined) {
            priceActionList[tabPage] = {};
          }
          // Remove devices that are no longer in use.
          for (var deviceId in priceActionList[tabPage]) {
            if (!(deviceId in deviceList) || !deviceList[deviceId].use) {
              delete priceActionList[tabPage][deviceId];
            }
          }
          // Add new devices
          for (var key in deviceList) {
            if (deviceList[key].use && !(key in priceActionList[tabPage])) {
              var new_op = DELTA_TEMP;
              if (!deviceList[key].thermostat_cap) {
                switch (tabPage) {
                  case PP_DIRTCHEAP:
                  case PP_LOW: new_op = TURN_ON; break;
                  case PP_NORM: new_op = EMERGENCY_OFF; break;
                  case PP_HIGH:
                  case PP_EXTREME: new_op = TURN_OFF; break;
                }
              }
              const tempChangeDirtCheapPrice = (deviceList[key].targetTemp > 50) ? 20 : Math.round(deviceList[key].targetTemp * 4 / 24);
              const tempChangeCheapPrice = (deviceList[key].targetTemp > 50) ? 15 : Math.round(deviceList[key].targetTemp * 3 / 24);
              const tempChangeHighPrice = (deviceList[key].targetTemp > 50) ? -10 : -Math.round(deviceList[key].targetTemp * 5 / 24);
              const tempChangeInsanePrice = (deviceList[key].targetTemp > 50) ? -30 : -Math.round(deviceList[key].targetTemp * 10 / 24);
              var new_delta = (tabPage == PP_LOW) ? tempChangeCheapPrice
                : (tabPage == PP_NORM) ?  0
                : (tabPage == PP_HIGH) ? tempChangeHighPrice
                : (tabPage == PP_EXTREME) ? tempChangeInsanePrice
                : tempChangeDirtCheapPrice;
              priceActionList[tabPage][key] = { delta: new_delta, operation: new_op }
            }
          }
        }
      }

      // -- Price Tab control -- //
      function changePriceTab(evt, tabPage) {
        // Update device list:
        refreshPriceActionList();
        generatePriceActionList(tabPage);

        // Get all elements with class="subtablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("subtablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        const currentTarget = document.getElementById(`subtablink${tabPage}`);
        if (currentTarget) currentTarget.className += " active";
      }

      // -- Mode Tab control -- //
      function refreshModeLists(newMode) {
        // add one new mode if '+' buttin is pressed
        const addMode = (newMode >= modeList.length && modeList.length < 8);
        const removeMode = (newMode == -1 && modeList.length > 3)
        if (addMode) {
          modeList.push(JSON.parse(JSON.stringify(modeList[0])));
          modeNames.push(`${modeNameCustomText} ${modeList.length-3}`);
        }
        if (removeMode) {
          modeList.pop();
          modeNames = modeNames.slice(0,modeList.length-3);
        }
        for (let modeId = 0; modeId < modeList.length; modeId++) {
          var up_to_date_elements = {};
          // First remove devices that are no longer in use.
          for (let i = modeList[modeId].length-1; i >= 0 ; i--) {
            if (!(modeList[modeId][i].id in deviceList) || !deviceList[modeList[modeId][i].id].use) {
              modeList[modeId].splice(i, 1);
            } else {
              up_to_date_elements[modeList[modeId][i].id] = true;
            }
          }
          // Add new devices
          for (let key in deviceList) {
            if (deviceList[key].use && !(key in up_to_date_elements)) {
              // Adjust target to accomodate for both mode, water heaters and make room for price point deltas
              let targetTemp = deviceList[key].targetTemp;
              switch (modeId) {
                case 0: targetTemp = (targetTemp > 50) ? 65 : targetTemp; break; // Normal
                case 1: targetTemp = (targetTemp > 50) ? 65 : Math.round(targetTemp*0.8); break; // Night
                case 2: targetTemp = (targetTemp > 50) ? 30 : Math.round(targetTemp*0.25); break; // Away
                default:
                case 3: targetTemp = (targetTemp > 50) ? 65 : Math.round(targetTemp*0.5); break; // Custom
              }
              modeList[modeId].push({ id: key, operation: CONTROLLED, targetTemp: targetTemp });
            }
          }
        }
        if (addMode || removeMode || needModeRefresh) {
          // Aquire Mode names
          const allModeNames = [
            modeNameDayText,
            modeNameNightText,
            modeNameHolidayText
          ];
          for (let i = 0; i < modeList.length-3; i++) {
            allModeNames.push(modeNames[i]);
          }
          if (modeList.length < 8) {
            allModeNames.push('+');
          }
          // Update Current mode selector
          const currentModeElement = document.getElementById('operatingMode');
          let prevOperatingMode = +currentModeElement.value;
          if (prevOperatingMode > modeList.length) {
            prevOperatingMode = modeList.length;
          }
          let newOperationModeText = '';
          for (let modeId = 1; modeId <= modeList.length; modeId++) {
            let selectedText = (prevOperatingMode === modeId) ? " selected": "";
            newOperationModeText +=
              `<option value="${modeId}"${selectedText}>${allModeNames[modeId-1]}</option>`;
          }
          currentModeElement.innerHTML = newOperationModeText;
          // Update Mode list selector
          const modeSelectorElement = document.getElementById('modeSelector');
          const numRows = (modeList.length === 3) ? 1 : 2;
          let newModeSelectorText = '';
          for (let row=0; row < numRows; row++) {
            newModeSelectorText += `<tr${row==1?' style="background-color:#a0d0d6;"':''}>`;
            for (let col=0; col < 4; col++) {
              let modeId = row*4 + col + 1;
              let active = modeId <= allModeNames.length;
              let saveHint = modeId == (modeList.length+1) ? 'displaySaveHint();' : '';
              let onClick = ` onclick="changeTab(event, 'priorityPage', ${modeId-1});${saveHint}"`;
              newModeSelectorText += active ?
                `<td id="tablink${modeId-1}" class="tablinks"${onClick}>${allModeNames[modeId-1]}</td>`
                  : '<td class="emptytab">&nbsp;</td>';

            }
            newModeSelectorText += '</tr>';
          }
          modeSelectorElement.innerHTML = newModeSelectorText;
          needModeRefresh = false;
        }
      }

      function refreshFrostList() {
        // Remove devices that are no longer in use.
        for (var deviceId in frostList) {
          if (!(deviceId in deviceList) || !deviceList[deviceId].use) {
            delete frostList[deviceId];
          }
        }
        // Add new devices
        for (var key in deviceList) {
          if (deviceList[key].use && !(key in frostList)) {
            frostList[key] = { minTemp: 5 }
          }
        }
      }

      function generateSupportedList() {
        let theList = '';
        for (let devType in DEVICE_TYPE) {
          let devTypeId = DEVICE_TYPE[devType];
          theList += `<h3>${deviceTypeText[devTypeId]}</h3>`;
          theList += '<table>';
          let allKeys = Object.keys(DEVICE_CMD);
          for (const devid in allKeys) {
            if (DEVICE_CMD[allKeys[devid]].type !== devTypeId)
              continue;
            let isExperimental = DEVICE_CMD[allKeys[devid]].beta === true;
            theList += '<tr>';
            theList +=   '<td>' + allKeys[devid] + '</td>';
            theList +=   '<td><b>' + (isExperimental?onGoingText:'') + '</b></td>';
            theList += '</tr>'
          }
          theList += '</table>';
        }
        return theList;
      }

      function allowDropdown() {
        let menuitem = document.getElementsByClassName("dropdown-content");
        for (let i = 0; i < menuitem.length; i++) {
          menuitem[i].classList.remove("active");
        }
      }

      // -- Tab control -- //
      function changeTab(evt, tabPage, modeId = undefined) {
        var i, tabcontent, tablinks;
        let currentTarget;
        if (evt) currentTarget = evt.currentTarget;

        // Update notifications in Welcome Page
        if (tabPage == 'welcomePage') {
          refreshTodoList();
          let limitTxt = '';
          if (document.getElementById('enLimit15').checked) {
            limitTxt += `${+document.getElementById("maxPower15min").value} Wh/15 min.${appConfigProgress.activeLimit == TIMESPAN.QUARTER ? ' <span class="blink">('+activeText+')</span>' : ''}`;
          }
          if (document.getElementById('enLimit60').checked) {
            limitTxt += (limitTxt.length > 0) ? '<br>' : '';
            limitTxt += `${+document.getElementById("maxPowerHour").value / 1000} kWh/hour${appConfigProgress.activeLimit == TIMESPAN.HOUR ? ' <span class="blink">('+activeText+')</span>' : ''}`;
          }
          if (document.getElementById('enLimitDay').checked) {
            limitTxt += (limitTxt.length > 0) ? '<br>' : '';
            limitTxt += `${+document.getElementById("maxPowerDay").value} kWh/day${appConfigProgress.activeLimit == TIMESPAN.DAY ? ' <span class="blink">('+activeText+')</span>' : ''}`;
          }
          if (document.getElementById('enLimitMonth').checked) {
            limitTxt += (limitTxt.length > 0) ? '<br>' : '';
            limitTxt += `${+document.getElementById("maxPowerMonth").value} kWh/month${appConfigProgress.activeLimit == TIMESPAN.MONTH ? ' <span class="blink">('+activeText+')</span>' : ''}`;
          }
          if (appConfigProgress.activeLimit == ALARMS.NO_POWER) {
            limitTxt += (limitTxt.length > 0) ? '<br>' : '';
            limitTxt += `${noPowText}. <span class="blink">(${activeText})</span>`;
          }
          document.getElementById('limitsDuplicate').innerHTML = limitTxt;
        }

        // Update devicelist for Frost Page
        if (tabPage == 'frostPage') {
          refreshFrostList();
          generateFrostList();
        }

        // Update zone list for Zone Page
        if (tabPage == 'overridePage') {
          generateOverrideList();
          generateZoneList();
        }

        // Update price page in case it has not been updated before
        if (tabPage == 'pricePage') {
          changePriceTab(evt, PP_NORM);
        }

        // Update the advanced settings page
        if (tabPage == 'chargerPage') {
          updateChargerHints(deviceList);
          updateAdvancedSettings();
        }

        // Refresh cost Schema page
        if (tabPage == 'costPage') {
          refreshSchema();
        }
        
        // Refresh the mode lists
        if (tabPage == 'priorityPage') {
          refreshModeLists(modeId);
          if (modeId == -1 && currentModeTab < modeList.length) {
            modeId = currentModeTab;
          } else if (modeId == -1) {
            modeId = modeList.length - 1;
          }
          generatePriorityList(modeId);
          currentModeTab = modeId;

          currentTarget = document.getElementById(`tablink${modeId}`);
          if (modeId > 2 && modeId == modeList.length -1) {
            document.getElementById('modeTrashCan').style.display = 'block';
          } else {
            document.getElementById('modeTrashCan').style.display = 'none';
          }
          if (modeId > 2) {
            document.getElementById('customModeFlags').style.display = 'block';
            document.getElementById('customModeName').value = modeNames[modeId-3];
          } else {
            document.getElementById('customModeFlags').style.display = 'none';
          }
        }

        // Refresh schedule page
        if (tabPage == 'schedulePage') {
          let inner = document.getElementById(`${tabPage}Inner`).contentWindow;
          try {
            console.log(`Sending data to iFrames`);
            // Sending translations
            const translations = JSON.stringify({
              id: 'translations',
              thermostat: thermostatText,
              settings: {
                schedule: timeScheduleText,
                ACMode: ACModeText
              },
              units: unitsText
            });
            inner.postMessage(translations, '*');
            const buffer = JSON.stringify({
              id: 'Initialize',
              data: {
                schedules
              }
            });
            inner.postMessage(buffer, '*');
          } catch (err) {
            console.log(`Could not access iFrame... ${err}`);
            // 
          }
        }


        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Hide the drop down menu
        let menuitem = document.getElementsByClassName("dropdown-content");
        for (i = 0; i < menuitem.length; i++) {
          menuitem[i].classList.add("active");
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabPage).style.display = "block";
        if (evt) currentTarget.className += " active";

        if (tabPage == 'logPage') changeToLogPage(debugMode);
        if (tabPage == 'schedulePage') document.getElementById(`${tabPage}Inner`).contentWindow.postMessage(JSON.stringify({id:'resize'}), '*');

        if (tabPage == 'backupPage') {
          // Make the log text area fill the page
          let backupElement = document.getElementById('backupBlob');
          backupElement.setAttribute('cols', (backupElement.parentElement.clientWidth-20) / 8);
          backupElement.style.height = (window.innerHeight - backupElement.offsetTop - 120) + 'px';
        }

        if (tabPage == 'helpSupportedPage') {
          document.getElementById('supportedDevicesList').innerHTML = generateSupportedList();
        }

        if (evt) evt.stopPropagation();
      };

      // Handling of iFrame function calls
      var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
      var eventer = window[eventMethod];
      var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

      var iFrameCallback = (event) => {
        var key = event.message ? "message" : "data";
        var data = event[key];
        //run function//
        if (event.origin === 'https://tools.developer.homey.app' ||
            event.origin === 'https://my.homey.app') {
          console.log('Ignoring message from homey http interface');
          return;
        }
        if ((event.origin !== window.location.origin) &&
          (event.origin !== 'null')) {
          console.log(`Message from unknown origin! (${event.origin})`);
          return;
        }
        console.log(`iFrame: ${data} from ${event.origin}`);
        const message = JSON.parse(data);
        if (message.id === 'displaySaveHint') {
          displaySaveHint();
        } else if (message.id === 'resize') {
          console.log(`Got resize message ${message.w}, ${message.h}`);
          //resizeIframe('schedulePage', message.w, message.h);
        } else if (message.id === 'wizAction') {
          runActionQueue(message.actionQueue);
          document.getElementById('main_menu').style.zIndex = (message.actionQueue[0].action === UI_SHOW_OVERLAY) ? 1 : 15;
        }
      };

      // Listen to message from child window
      eventer(messageEvent, iFrameCallback, false);

    </script>
  </body>
</html>